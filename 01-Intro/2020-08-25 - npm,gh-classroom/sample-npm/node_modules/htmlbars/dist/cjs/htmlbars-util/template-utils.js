exports.__esModule = true;
var _slice = Array.prototype.slice;
exports.RenderState = RenderState;
exports.blockFor = blockFor;
exports.renderAndCleanup = renderAndCleanup;
exports.clearMorph = clearMorph;
exports.clearMorphList = clearMorphList;
exports.buildStatement = buildStatement;

var _htmlbarsUtilMorphUtils = require("../htmlbars-util/morph-utils");

var _htmlbarsRuntimeRender = require("../htmlbars-runtime/render");

function RenderState(renderNode, morphList) {
  // The morph list that is no longer needed and can be
  // destroyed.
  this.morphListToClear = morphList;

  // The morph list that needs to be pruned of any items
  // that were not yielded on a subsequent render.
  this.morphListToPrune = null;

  // A map of morphs for each item yielded in during this
  // rendering pass. Any morphs in the DOM but not in this map
  // will be pruned during cleanup.
  this.handledMorphs = {};
  this.collisions = undefined;

  // The morph to clear once rendering is complete. By
  // default, we set this to the previous morph (to catch
  // the case where nothing is yielded; in that case, we
  // should just clear the morph). Otherwise this gets set
  // to null if anything is rendered.
  this.morphToClear = renderNode;

  this.shadowOptions = null;
}

function Block(render, template, blockOptions) {
  this.render = render;
  this.template = template;
  this.blockOptions = blockOptions;
  this.arity = template.arity;
}

Block.prototype.invoke = function (env, blockArguments, _self, renderNode, parentScope, visitor) {
  if (renderNode.lastResult) {
    renderNode.lastResult.revalidateWith(env, undefined, _self, blockArguments, visitor);
  } else {
    this._firstRender(env, blockArguments, _self, renderNode, parentScope);
  }
};

Block.prototype._firstRender = function (env, blockArguments, _self, renderNode, parentScope) {
  var options = { renderState: new RenderState(renderNode) };
  var render = this.render;
  var template = this.template;
  var scope = this.blockOptions.scope;

  var shadowScope = scope ? env.hooks.createChildScope(scope) : env.hooks.createFreshScope();

  env.hooks.bindShadowScope(env, parentScope, shadowScope, this.blockOptions.options);

  if (_self !== undefined) {
    env.hooks.bindSelf(env, shadowScope, _self);
  } else if (this.blockOptions.self !== undefined) {
    env.hooks.bindSelf(env, shadowScope, this.blockOptions.self);
  }

  bindBlocks(env, shadowScope, this.blockOptions.yieldTo);

  renderAndCleanup(renderNode, env, options, null, function () {
    options.renderState.morphToClear = null;
    var renderOptions = new _htmlbarsRuntimeRender.RenderOptions(renderNode, undefined, blockArguments);
    render(template, env, shadowScope, renderOptions);
  });
};

function blockFor(render, template, blockOptions) {
  return new Block(render, template, blockOptions);
}

function bindBlocks(env, shadowScope, blocks) {
  if (!blocks) {
    return;
  }
  if (blocks instanceof Block) {
    env.hooks.bindBlock(env, shadowScope, blocks);
  } else {
    for (var name in blocks) {
      if (blocks.hasOwnProperty(name)) {
        env.hooks.bindBlock(env, shadowScope, blocks[name], name);
      }
    }
  }
}

function renderAndCleanup(morph, env, options, shadowOptions, callback) {
  // The RenderState object is used to collect information about what the
  // helper or hook being invoked has yielded. Once it has finished either
  // yielding multiple items (via yieldItem) or a single template (via
  // yieldTemplate), we detect what was rendered and how it differs from
  // the previous render, cleaning up old state in DOM as appropriate.
  var renderState = options.renderState;
  renderState.collisions = undefined;
  renderState.shadowOptions = shadowOptions;

  // Invoke the callback, instructing it to save information about what it
  // renders into RenderState.
  var result = callback(options);

  // The hook can opt-out of cleanup if it handled cleanup itself.
  if (result && result.handled) {
    return;
  }

  var morphMap = morph.morphMap;

  // Walk the morph list, clearing any items that were yielded in a previous
  // render but were not yielded during this render.
  var morphList = renderState.morphListToPrune;
  if (morphList) {
    var handledMorphs = renderState.handledMorphs;
    var item = morphList.firstChildMorph;

    while (item) {
      var next = item.nextMorph;

      // If we don't see the key in handledMorphs, it wasn't
      // yielded in and we can safely remove it from DOM.
      if (!(item.key in handledMorphs)) {
        morphMap[item.key] = undefined;
        clearMorph(item, env, true);
        item.destroy();
      }

      item = next;
    }
  }

  morphList = renderState.morphListToClear;
  if (morphList) {
    clearMorphList(morphList, morph, env);
  }

  var toClear = renderState.morphToClear;
  if (toClear) {
    clearMorph(toClear, env);
  }
}

function clearMorph(morph, env, destroySelf) {
  var cleanup = env.hooks.cleanupRenderNode;
  var destroy = env.hooks.destroyRenderNode;
  var willCleanup = env.hooks.willCleanupTree;
  var didCleanup = env.hooks.didCleanupTree;

  function destroyNode(node) {
    if (cleanup) {
      cleanup(node);
    }
    if (destroy) {
      destroy(node);
    }
  }

  if (willCleanup) {
    willCleanup(env, morph, destroySelf);
  }
  if (cleanup) {
    cleanup(morph);
  }
  if (destroySelf && destroy) {
    destroy(morph);
  }

  _htmlbarsUtilMorphUtils.visitChildren(morph.childNodes, destroyNode);

  // TODO: Deal with logical children that are not in the DOM tree
  morph.clear();
  if (didCleanup) {
    didCleanup(env, morph, destroySelf);
  }

  morph.lastResult = null;
  morph.lastYielded = null;
  morph.childNodes = null;
}

function clearMorphList(morphList, morph, env) {
  var item = morphList.firstChildMorph;

  while (item) {
    var next = item.nextMorph;
    morph.morphMap[item.key] = undefined;
    clearMorph(item, env, true);
    item.destroy();

    item = next;
  }

  // Remove the MorphList from the morph.
  morphList.clear();
  morph.morphList = null;
}

function buildStatement() {
  var statement = [].concat(_slice.call(arguments));

  // ensure array length is 7 by padding with 0
  for (var i = arguments.length; i < 7; i++) {
    statement[i] = 0;
  }

  return statement;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXV0aWwvdGVtcGxhdGUtdXRpbHMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O3NDQUE4Qiw4QkFBOEI7O3FDQUM5Qiw0QkFBNEI7O0FBRW5ELFNBQVMsV0FBVyxDQUFDLFVBQVUsRUFBRSxTQUFTLEVBQUU7OztBQUdqRCxNQUFJLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDOzs7O0FBSWxDLE1BQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7Ozs7O0FBSzdCLE1BQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3hCLE1BQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDOzs7Ozs7O0FBTzVCLE1BQUksQ0FBQyxZQUFZLEdBQUcsVUFBVSxDQUFDOztBQUUvQixNQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQztDQUMzQjs7QUFFRCxTQUFTLEtBQUssQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRTtBQUM3QyxNQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztBQUNyQixNQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztBQUN6QixNQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztBQUNqQyxNQUFJLENBQUMsS0FBSyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUM7Q0FDN0I7O0FBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsVUFBUyxHQUFHLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRTtBQUM5RixNQUFJLFVBQVUsQ0FBQyxVQUFVLEVBQUU7QUFDekIsY0FBVSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0dBQ3RGLE1BQU07QUFDTCxRQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxjQUFjLEVBQUUsS0FBSyxF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QUFHLFNBQVMsQ0FBQyxlQUFlLENBQUM7O0FBRXJDLFNBQU8sSUFBSSxFQUFFO0FBQ1gsUUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztBQUMxQixTQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUM7QUFDckMsY0FBVSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDNUIsUUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDOztBQUVmLFFBQUksR0FBRyxJQUFJLENBQUM7R0FDYjs7O0FBR0QsV0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2xCLE9BQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO0NBQ3hCOztBQUVNLFNBQVMsY0FBYyxHQUFHO0FBQy9CLE1BQUksU0FBUyx5QkFBTyxTQUFTLEVBQUMsQ0FBQzs7O0FBRy9CLE9BQUssSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3pDLGFBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7R0FDbEI7O0FBRUQsU0FBTyxTQUFTLENBQUM7Q0FDbEIiLCJmaWxlIjoiaHRtbGJhcnMtdXRpbC90ZW1wbGF0ZS11dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHZpc2l0Q2hpbGRyZW4gfSBmcm9tIFwiLi4vaHRtbGJhcnMtdXRpbC9tb3JwaC11dGlsc1wiO1xuaW1wb3J0IHsgUmVuZGVyT3B0aW9ucyB9IGZyb20gXCIuLi9odG1sYmFycy1ydW50aW1lL3JlbmRlclwiO1xuXG5leHBvcnQgZnVuY3Rpb24gUmVuZGVyU3RhdGUocmVuZGVyTm9kZSwgbW9ycGhMaXN0KSB7XG4gIC8vIFRoZSBtb3JwaCBsaXN0IHRoYXQgaXMgbm8gbG9uZ2VyIG5lZWRlZCBhbmQgY2FuIGJlXG4gIC8vIGRlc3Ryb3llZC5cbiAgdGhpcy5tb3JwaExpc3RUb0NsZWFyID0gbW9ycGhMaXN0O1xuXG4gIC8vIFRoZSBtb3JwaCBsaXN0IHRoYXQgbmVlZHMgdG8gYmUgcHJ1bmVkIG9mIGFueSBpdGVtc1xuICAvLyB0aGF0IHdlcmUgbm90IHlpZWxkZWQgb24gYSBzdWJzZXF1ZW50IHJlbmRlci5cbiAgdGhpcy5tb3JwaExpc3RUb1BydW5lID0gbnVsbDtcblxuICAvLyBBIG1hcCBvZiBtb3JwaHMgZm9yIGVhY2ggaXRlbSB5aWVsZGVkIGluIGR1cmluZyB0aGlzXG4gIC8vIHJlbmRlcmluZyBwYXNzLiBBbnkgbW9ycGhzIGluIHRoZSBET00gYnV0IG5vdCBpbiB0aGlzIG1hcFxuICAvLyB3aWxsIGJlIHBydW5lZCBkdXJpbmcgY2xlYW51cC5cbiAgdGhpcy5oYW5kbGVkTW9ycGhzID0ge307XG4gIHRoaXMuY29sbGlzaW9ucyA9IHVuZGVmaW5lZDtcblxuICAvLyBUaGUgbW9ycGggdG8gY2xlYXIgb25jZSByZW5kZXJpbmcgaXMgY29tcGxldGUuIEJ5XG4gIC8vIGRlZmF1bHQsIHdlIHNldCB0aGlzIHRvIHRoZSBwcmV2aW91cyBtb3JwaCAodG8gY2F0Y2hcbiAgLy8gdGhlIGNhc2Ugd2hlcmUgbm90aGluZyBpcyB5aWVsZGVkOyBpbiB0aGF0IGNhc2UsIHdlXG4gIC8vIHNob3VsZCBqdXN0IGNsZWFyIHRoZSBtb3JwaCkuIE90aGVyd2lzZSB0aGlzIGdldHMgc2V0XG4gIC8vIHRvIG51bGwgaWYgYW55dGhpbmcgaXMgcmVuZGVyZWQuXG4gIHRoaXMubW9ycGhUb0NsZWFyID0gcmVuZGVyTm9kZTtcblxuICB0aGlzLnNoYWRvd09wdGlvbnMgPSBudWxsO1xufVxuXG5mdW5jdGlvbiBCbG9jayhyZW5kZXIsIHRlbXBsYXRlLCBibG9ja09wdGlvbnMpIHtcbiAgdGhpcy5yZW5kZXIgPSByZW5kZXI7XG4gIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgdGhpcy5ibG9ja09wdGlvbnMgPSBibG9ja09wdGlvbnM7XG4gIHRoaXMuYXJpdHkgPSB0ZW1wbGF0ZS5hcml0eTtcbn1cblxuQmxvY2sucHJvdG90eXBlLmludm9rZSA9IGZ1bmN0aW9uKGVudiwgYmxvY2tBcmd1bWVudHMsIF9zZWxmLCByZW5kZXJOb2RlLCBwYXJlbnRTY29wZSwgdmlzaXRvcikge1xuICBpZiAocmVuZGVyTm9kZS5sYXN0UmVzdWx0KSB7XG4gICAgcmVuZGVyTm9kZS5sYXN0UmVzdWx0LnJldmFsaWRhdGVXaXRoKGVudiwgdW5kZWZpbmVkLCBfc2VsZiwgYmxvY2tBcmd1bWVudHMsIHZpc2l0b3IpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMuX2ZpcnN0UmVuZGVyKGVudiwgYmxvY2tBcmd1bWVudHMsIF9zZWxmLCByZW5kZXJOb2RlLCBwYXJlbnRTY29wZSk7XG4gIH1cbn07XG5cbkJsb2NrLnByb3RvdHlwZS5fZmlyc3RSZW5kZXIgPSBmdW5jdGlvbihlbnYsIGJsb2NrQXJndW1lbnRzLCBfc2VsZiwgcmVuZGVyTm9kZSwgcGFyZW50U2NvcGUpIHtcbiAgbGV0IG9wdGlvbnMgPSB7IHJlbmRlclN0YXRlOiBuZXcgUmVuZGVyU3RhdGUocmVuZGVyTm9kZSkgfTtcbiAgbGV0IHsgcmVuZGVyLCB0ZW1wbGF0ZSwgYmxvY2tPcHRpb25zOiB7IHNjb3BlIH0gfSA9IHRoaXM7XG4gIGxldCBzaGFkb3dTY29wZSA9IHNjb3BlID8gZW52Lmhvb2tzLmNyZWF0ZUNoaWxkU2NvcGUoc2NvcGUpIDogZW52Lmhvb2tzLmNyZWF0ZUZyZXNoU2NvcGUoKTtcblxuICBlbnYuaG9va3MuYmluZFNoYWRvd1Njb3BlKGVudiwgcGFyZW50U2NvcGUsIHNoYWRvd1Njb3BlLCB0aGlzLmJsb2NrT3B0aW9ucy5vcHRpb25zKTtcblxuICBpZiAoX3NlbGYgIT09IHVuZGVmaW5lZCkge1xuICAgIGVudi5ob29rcy5iaW5kU2VsZihlbnYsIHNoYWRvd1Njb3BlLCBfc2VsZik7XG4gIH0gZWxzZSBpZiAodGhpcy5ibG9ja09wdGlvbnMuc2VsZiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgZW52Lmhvb2tzLmJpbmRTZWxmKGVudiwgc2hhZG93U2NvcGUsIHRoaXMuYmxvY2tPcHRpb25zLnNlbGYpO1xuICB9XG5cbiAgYmluZEJsb2NrcyhlbnYsIHNoYWRvd1Njb3BlLCB0aGlzLmJsb2NrT3B0aW9ucy55aWVsZFRvKTtcblxuICByZW5kZXJBbmRDbGVhbnVwKHJlbmRlck5vZGUsIGVudiwgb3B0aW9ucywgbnVsbCwgZnVuY3Rpb24oKSB7XG4gICAgb3B0aW9ucy5yZW5kZXJTdGF0ZS5tb3JwaFRvQ2xlYXIgPSBudWxsO1xuICAgIGxldCByZW5kZXJPcHRpb25zID0gbmV3IFJlbmRlck9wdGlvbnMocmVuZGVyTm9kZSwgdW5kZWZpbmVkLCBibG9ja0FyZ3VtZW50cyk7XG4gICAgcmVuZGVyKHRlbXBsYXRlLCBlbnYsIHNoYWRvd1Njb3BlLCByZW5kZXJPcHRpb25zKTtcbiAgfSk7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gYmxvY2tGb3IocmVuZGVyLCB0ZW1wbGF0ZSwgYmxvY2tPcHRpb25zKSB7XG4gIHJldHVybiBuZXcgQmxvY2socmVuZGVyLCB0ZW1wbGF0ZSwgYmxvY2tPcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gYmluZEJsb2NrcyhlbnYsIHNoYWRvd1Njb3BlLCBibG9ja3MpIHtcbiAgaWYgKCFibG9ja3MpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKGJsb2NrcyBpbnN0YW5jZW9mIEJsb2NrKSB7XG4gICAgZW52Lmhvb2tzLmJpbmRCbG9jayhlbnYsIHNoYWRvd1Njb3BlLCBibG9ja3MpO1xuICB9IGVsc2Uge1xuICAgIGZvciAodmFyIG5hbWUgaW4gYmxvY2tzKSB7XG4gICAgICBpZiAoYmxvY2tzLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgIGVudi5ob29rcy5iaW5kQmxvY2soZW52LCBzaGFkb3dTY29wZSwgYmxvY2tzW25hbWVdLCBuYW1lKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlckFuZENsZWFudXAobW9ycGgsIGVudiwgb3B0aW9ucywgc2hhZG93T3B0aW9ucywgY2FsbGJhY2spIHtcbiAgLy8gVGhlIFJlbmRlclN0YXRlIG9iamVjdCBpcyB1c2VkIHRvIGNvbGxlY3QgaW5mb3JtYXRpb24gYWJvdXQgd2hhdCB0aGVcbiAgLy8gaGVscGVyIG9yIGhvb2sgYmVpbmcgaW52b2tlZCBoYXMgeWllbGRlZC4gT25jZSBpdCBoYXMgZmluaXNoZWQgZWl0aGVyXG4gIC8vIHlpZWxkaW5nIG11bHRpcGxlIGl0ZW1zICh2aWEgeWllbGRJdGVtKSBvciBhIHNpbmdsZSB0ZW1wbGF0ZSAodmlhXG4gIC8vIHlpZWxkVGVtcGxhdGUpLCB3ZSBkZXRlY3Qgd2hhdCB3YXMgcmVuZGVyZWQgYW5kIGhvdyBpdCBkaWZmZXJzIGZyb21cbiAgLy8gdGhlIHByZXZpb3VzIHJlbmRlciwgY2xlYW5pbmcgdXAgb2xkIHN0YXRlIGluIERPTSBhcyBhcHByb3ByaWF0ZS5cbiAgdmFyIHJlbmRlclN0YXRlID0gb3B0aW9ucy5yZW5kZXJTdGF0ZTtcbiAgcmVuZGVyU3RhdGUuY29sbGlzaW9ucyA9IHVuZGVmaW5lZDtcbiAgcmVuZGVyU3RhdGUuc2hhZG93T3B0aW9ucyA9IHNoYWRvd09wdGlvbnM7XG5cbiAgLy8gSW52b2tlIHRoZSBjYWxsYmFjaywgaW5zdHJ1Y3RpbmcgaXQgdG8gc2F2ZSBpbmZvcm1hdGlvbiBhYm91dCB3aGF0IGl0XG4gIC8vIHJlbmRlcnMgaW50byBSZW5kZXJTdGF0ZS5cbiAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrKG9wdGlvbnMpO1xuXG4gIC8vIFRoZSBob29rIGNhbiBvcHQtb3V0IG9mIGNsZWFudXAgaWYgaXQgaGFuZGxlZCBjbGVhbnVwIGl0c2VsZi5cbiAgaWYgKHJlc3VsdCAmJiByZXN1bHQuaGFuZGxlZCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIHZhciBtb3JwaE1hcCA9IG1vcnBoLm1vcnBoTWFwO1xuXG4gIC8vIFdhbGsgdGhlIG1vcnBoIGxpc3QsIGNsZWFyaW5nIGFueSBpdGVtcyB0aGF0IHdlcmUgeWllbGRlZCBpbiBhIHByZXZpb3VzXG4gIC8vIHJlbmRlciBidXQgd2VyZSBub3QgeWllbGRlZCBkdXJpbmcgdGhpcyByZW5kZXIuXG4gIGxldCBtb3JwaExpc3QgPSByZW5kZXJTdGF0ZS5tb3JwaExpc3RUb1BydW5lO1xuICBpZiAobW9ycGhMaXN0KSB7XG4gICAgbGV0IGhhbmRsZWRNb3JwaHMgPSByZW5kZXJTdGF0ZS5oYW5kbGVkTW9ycGhzO1xuICAgIGxldCBpdGVtID0gbW9ycGhMaXN0LmZpcnN0Q2hpbGRNb3JwaDtcblxuICAgIHdoaWxlIChpdGVtKSB7XG4gICAgICBsZXQgbmV4dCA9IGl0ZW0ubmV4dE1vcnBoO1xuXG4gICAgICAvLyBJZiB3ZSBkb24ndCBzZWUgdGhlIGtleSBpbiBoYW5kbGVkTW9ycGhzLCBpdCB3YXNuJ3RcbiAgICAgIC8vIHlpZWxkZWQgaW4gYW5kIHdlIGNhbiBzYWZlbHkgcmVtb3ZlIGl0IGZyb20gRE9NLlxuICAgICAgaWYgKCEoaXRlbS5rZXkgaW4gaGFuZGxlZE1vcnBocykpIHtcbiAgICAgICAgbW9ycGhNYXBbaXRlbS5rZXldID0gdW5kZWZpbmVkO1xuICAgICAgICBjbGVhck1vcnBoKGl0ZW0sIGVudiwgdHJ1ZSk7XG4gICAgICAgIGl0ZW0uZGVzdHJveSgpO1xuICAgICAgfVxuXG4gICAgICBpdGVtID0gbmV4dDtcbiAgICB9XG4gIH1cblxuICBtb3JwaExpc3QgPSByZW5kZXJTdGF0ZS5tb3JwaExpc3RUb0NsZWFyO1xuICBpZiAobW9ycGhMaXN0KSB7XG4gICAgY2xlYXJNb3JwaExpc3QobW9ycGhMaXN0LCBtb3JwaCwgZW52KTtcbiAgfVxuXG4gIGxldCB0b0NsZWFyID0gcmVuZGVyU3RhdGUubW9ycGhUb0NsZWFyO1xuICBpZiAodG9DbGVhcikge1xuICAgIGNsZWFyTW9ycGgodG9DbGVhciwgZW52KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJNb3JwaChtb3JwaCwgZW52LCBkZXN0cm95U2VsZikge1xuICB2YXIgY2xlYW51cCA9IGVudi5ob29rcy5jbGVhbnVwUmVuZGVyTm9kZTtcbiAgdmFyIGRlc3Ryb3kgPSBlbnYuaG9va3MuZGVzdHJveVJlbmRlck5vZGU7XG4gIHZhciB3aWxsQ2xlYW51cCA9IGVudi5ob29rcy53aWxsQ2xlYW51cFRyZWU7XG4gIHZhciBkaWRDbGVhbnVwID0gZW52Lmhvb2tzLmRpZENsZWFudXBUcmVlO1xuXG4gIGZ1bmN0aW9uIGRlc3Ryb3lOb2RlKG5vZGUpIHtcbiAgICBpZiAoY2xlYW51cCkgeyBjbGVhbnVwKG5vZGUpOyB9XG4gICAgaWYgKGRlc3Ryb3kpIHsgZGVzdHJveShub2RlKTsgfVxuICB9XG5cbiAgaWYgKHdpbGxDbGVhbnVwKSB7IHdpbGxDbGVhbnVwKGVudiwgbW9ycGgsIGRlc3Ryb3lTZWxmKTsgfVxuICBpZiAoY2xlYW51cCkgeyBjbGVhbnVwKG1vcnBoKTsgfVxuICBpZiAoZGVzdHJveVNlbGYgJiYgZGVzdHJveSkgeyBkZXN0cm95KG1vcnBoKTsgfVxuXG4gIHZpc2l0Q2hpbGRyZW4obW9ycGguY2hpbGROb2RlcywgZGVzdHJveU5vZGUpO1xuXG4gIC8vIFRPRE86IERlYWwgd2l0aCBsb2dpY2FsIGNoaWxkcmVuIHRoYXQgYXJlIG5vdCBpbiB0aGUgRE9NIHRyZWVcbiAgbW9ycGguY2xlYXIoKTtcbiAgaWYgKGRpZENsZWFudXApIHsgZGlkQ2xlYW51cChlbnYsIG1vcnBoLCBkZXN0cm95U2VsZik7IH1cblxuICBtb3JwaC5sYXN0UmVzdWx0ID0gbnVsbDtcbiAgbW9ycGgubGFzdFlpZWxkZWQgPSBudWxsO1xuICBtb3JwaC5jaGlsZE5vZGVzID0gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsZWFyTW9ycGhMaXN0KG1vcnBoTGlzdCwgbW9ycGgsIGVudikge1xuICBsZXQgaXRlbSA9IG1vcnBoTGlzdC5maXJzdENoaWxkTW9ycGg7XG5cbiAgd2hpbGUgKGl0ZW0pIHtcbiAgICBsZXQgbmV4dCA9IGl0ZW0ubmV4dE1vcnBoO1xuICAgIG1vcnBoLm1vcnBoTWFwW2l0ZW0ua2V5XSA9IHVuZGVmaW5lZDtcbiAgICBjbGVhck1vcnBoKGl0ZW0sIGVudiwgdHJ1ZSk7XG4gICAgaXRlbS5kZXN0cm95KCk7XG5cbiAgICBpdGVtID0gbmV4dDtcbiAgfVxuXG4gIC8vIFJlbW92ZSB0aGUgTW9ycGhMaXN0IGZyb20gdGhlIG1vcnBoLlxuICBtb3JwaExpc3QuY2xlYXIoKTtcbiAgbW9ycGgubW9ycGhMaXN0ID0gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkU3RhdGVtZW50KCkge1xuICBsZXQgc3RhdGVtZW50ID0gWy4uLmFyZ3VtZW50c107XG5cbiAgLy8gZW5zdXJlIGFycmF5IGxlbmd0aCBpcyA3IGJ5IHBhZGRpbmcgd2l0aCAwXG4gIGZvciAobGV0IGkgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgNzsgaSsrKSB7XG4gICAgc3RhdGVtZW50W2ldID0gMDtcbiAgfVxuXG4gIHJldHVybiBzdGF0ZW1lbnQ7XG59XG4iXX0=