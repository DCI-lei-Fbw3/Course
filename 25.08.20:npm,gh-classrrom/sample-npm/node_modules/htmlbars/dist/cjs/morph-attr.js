exports.__esModule = true;

var _morphAttrSanitizeAttributeValue = require("./morph-attr/sanitize-attribute-value");

var _domHelperProp = require("./dom-helper/prop");

var _domHelperBuildHtmlDom = require("./dom-helper/build-html-dom");

var _htmlbarsUtil = require("./htmlbars-util");

function getProperty() {
  return this.domHelper.getPropertyStrict(this.element, this.attrName);
}

function updateProperty(value) {
  if (this._renderedInitially === true || !_domHelperProp.isAttrRemovalValue(value)) {
    var element = this.element;
    var attrName = this.attrName;

    if (attrName === 'value' && element.tagName === 'INPUT' && element.value === value) {
      // Do nothing. Attempts to avoid accidently changing the input cursor location.
      // See https://github.com/tildeio/htmlbars/pull/447 for more details.
    } else {
        // do not render if initial value is undefined or null
        this.domHelper.setPropertyStrict(element, attrName, value);
      }
  }

  this._renderedInitially = true;
}

function getAttribute() {
  return this.domHelper.getAttribute(this.element, this.attrName);
}

// normalize to be more inline with updateProperty behavior
function normalizeAttributeValue(value) {
  if (value === false || value === undefined || value === null) {
    return null;
  }
  if (value === true) {
    return '';
  }
  // onclick function etc in SSR
  if (typeof value === 'function') {
    return null;
  }
  return String(value);
}

function updateAttribute(_value) {
  var value = normalizeAttributeValue(_value);
  if (_domHelperProp.isAttrRemovalValue(value)) {
    this.domHelper.removeAttribute(this.element, this.attrName);
  } else {
    this.domHelper.setAttribute(this.element, this.attrName, value);
  }
}

function getAttributeNS() {
  return this.domHelper.getAttributeNS(this.element, this.namespace, this.attrName);
}

function updateAttributeNS(_value) {
  var value = normalizeAttributeValue(_value);
  if (_domHelperProp.isAttrRemovalValue(value)) {
    this.domHelper.removeAttribute(this.element, this.attrName);
  } else {
    this.domHelper.setAttributeNS(this.element, this.namespace, this.attrName, value);
  }
}

var UNSET = { unset: true };

var guid = 1;

AttrMorph.create = function (element, attrName, domHelper, namespace) {
  var ns = _htmlbarsUtil.getAttrNamespace(attrName, namespace);

  if (ns) {
    return new AttributeNSAttrMorph(element, attrName, domHelper, ns);
  } else {
    return createNonNamespacedAttrMorph(element, attrName, domHelper);
  }
};

function createNonNamespacedAttrMorph(element, attrName, domHelper) {
  var _normalizeProperty = _domHelperProp.normalizeProperty(element, attrName);

  var normalized = _normalizeProperty.normalized;
  var type = _normalizeProperty.type;

  if (element.namespaceURI === _domHelperBuildHtmlDom.svgNamespace || attrName === 'style' || type === 'attr') {
    return new AttributeAttrMorph(element, normalized, domHelper);
  } else {
    return new PropertyAttrMorph(element, normalized, domHelper);
  }
}

function AttrMorph(element, attrName, domHelper) {
  this.element = element;
  this.domHelper = domHelper;
  this.attrName = attrName;
  this._state = undefined;
  this.isDirty = false;
  this.isSubtreeDirty = false;
  this.escaped = true;
  this.lastValue = UNSET;
  this.lastResult = null;
  this.lastYielded = null;
  this.childNodes = null;
  this.linkedParams = null;
  this.linkedResult = null;
  this.guid = "attr" + guid++;
  this.seen = false;
  this.ownerNode = null;
  this.rendered = false;
  this._renderedInitially = false;
  this.namespace = undefined;
  this.didInit();
}

AttrMorph.prototype.getState = function () {
  if (!this._state) {
    this._state = {};
  }

  return this._state;
};

AttrMorph.prototype.setState = function (newState) {
  /*jshint -W093 */

  return this._state = newState;
};

AttrMorph.prototype.didInit = function () {};
AttrMorph.prototype.willSetContent = function () {};

AttrMorph.prototype.setContent = function (value) {
  this.willSetContent(value);

  if (this.lastValue === value) {
    return;
  }
  this.lastValue = value;

  if (this.escaped) {
    var sanitized = _morphAttrSanitizeAttributeValue.sanitizeAttributeValue(this.domHelper, this.element, this.attrName, value);
    this._update(sanitized, this.namespace);
  } else {
    this._update(value, this.namespace);
  }
};

AttrMorph.prototype.getContent = function () {
  var value = this.lastValue = this._get();
  return value;
};

// renderAndCleanup calls `clear` on all items in the morph map
// just before calling `destroy` on the morph.
//
// As a future refactor this could be changed to set the property
// back to its original/default value.
AttrMorph.prototype.clear = function () {};

AttrMorph.prototype.destroy = function () {
  this.element = null;
  this.domHelper = null;
};

AttrMorph.prototype._$superAttrMorph = AttrMorph;

function PropertyAttrMorph(element, attrName, domHelper) {
  this._$superAttrMorph(element, attrName, domHelper);
}

PropertyAttrMorph.prototype = Object.create(AttrMorph.prototype);
PropertyAttrMorph.prototype._update = updateProperty;
PropertyAttrMorph.prototype._get = getProperty;

function AttributeNSAttrMorph(element, attrName, domHelper, namespace) {
  this._$superAttrMorph(element, attrName, domHelper);
  this.namespace = namespace;
}

AttributeNSAttrMorph.prototype = Object.create(AttrMorph.prototype);
AttributeNSAttrMorph.prototype._update = updateAttributeNS;
AttributeNSAttrMorph.prototype._get = getAttributeNS;

function AttributeAttrMorph(element, attrName, domHelper) {
  this._$superAttrMorph(element, attrName, domHelper);
}

AttributeAttrMorph.prototype = Object.create(AttrMorph.prototype);
AttributeAttrMorph.prototype._update = updateAttribute;
AttributeAttrMorph.prototype._get = getAttribute;

exports.default = AttrMorph;
exports.sanitizeAttributeValue = _morphAttrSanitizeAttributeValue.sanitizeAttributeValue;
//# sourceMappingURL=data:application/json;base64,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LENBQUMsU0FBUyxDQUFDLE9BQU8sR0FBRyxlQUFlLENBQUM7QUFDdkQsa0JBQWtCLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUM7O2tCQUVsQyxTQUFTO1FBRWYsc0JBQXNCIiwiZmlsZSI6Im1vcnBoLWF0dHIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlIH0gZnJvbSBcIi4vbW9ycGgtYXR0ci9zYW5pdGl6ZS1hdHRyaWJ1dGUtdmFsdWVcIjtcbmltcG9ydCB7IGlzQXR0clJlbW92YWxWYWx1ZSwgbm9ybWFsaXplUHJvcGVydHkgfSBmcm9tIFwiLi9kb20taGVscGVyL3Byb3BcIjtcbmltcG9ydCB7IHN2Z05hbWVzcGFjZSB9IGZyb20gXCIuL2RvbS1oZWxwZXIvYnVpbGQtaHRtbC1kb21cIjtcbmltcG9ydCB7IGdldEF0dHJOYW1lc3BhY2UgfSBmcm9tIFwiLi9odG1sYmFycy11dGlsXCI7XG5cbmZ1bmN0aW9uIGdldFByb3BlcnR5KCkge1xuICByZXR1cm4gdGhpcy5kb21IZWxwZXIuZ2V0UHJvcGVydHlTdHJpY3QodGhpcy5lbGVtZW50LCB0aGlzLmF0dHJOYW1lKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlUHJvcGVydHkodmFsdWUpIHtcbiAgaWYgKHRoaXMuX3JlbmRlcmVkSW5pdGlhbGx5ID09PSB0cnVlIHx8ICFpc0F0dHJSZW1vdmFsVmFsdWUodmFsdWUpKSB7XG4gICAgbGV0IGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7XG4gICAgbGV0IGF0dHJOYW1lID0gdGhpcy5hdHRyTmFtZTtcblxuICAgIGlmIChhdHRyTmFtZSA9PT0gJ3ZhbHVlJyAmJiBlbGVtZW50LnRhZ05hbWUgPT09ICdJTlBVVCcgJiYgZWxlbWVudC52YWx1ZSA9PT0gdmFsdWUpIHtcbiAgICAgIC8vIERvIG5vdGhpbmcuIEF0dGVtcHRzIHRvIGF2b2lkIGFjY2lkZW50bHkgY2hhbmdpbmcgdGhlIGlucHV0IGN1cnNvciBsb2NhdGlvbi5cbiAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vdGlsZGVpby9odG1sYmFycy9wdWxsLzQ0NyBmb3IgbW9yZSBkZXRhaWxzLlxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBkbyBub3QgcmVuZGVyIGlmIGluaXRpYWwgdmFsdWUgaXMgdW5kZWZpbmVkIG9yIG51bGxcbiAgICAgIHRoaXMuZG9tSGVscGVyLnNldFByb3BlcnR5U3RyaWN0KGVsZW1lbnQsIGF0dHJOYW1lLCB2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgdGhpcy5fcmVuZGVyZWRJbml0aWFsbHkgPSB0cnVlO1xufVxuXG5mdW5jdGlvbiBnZXRBdHRyaWJ1dGUoKSB7XG4gIHJldHVybiB0aGlzLmRvbUhlbHBlci5nZXRBdHRyaWJ1dGUodGhpcy5lbGVtZW50LCB0aGlzLmF0dHJOYW1lKTtcbn1cblxuLy8gbm9ybWFsaXplIHRvIGJlIG1vcmUgaW5saW5lIHdpdGggdXBkYXRlUHJvcGVydHkgYmVoYXZpb3JcbmZ1bmN0aW9uIG5vcm1hbGl6ZUF0dHJpYnV0ZVZhbHVlKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gZmFsc2UgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGlmICh2YWx1ZSA9PT0gdHJ1ZSkge1xuICAgIHJldHVybiAnJztcbiAgfVxuICAvLyBvbmNsaWNrIGZ1bmN0aW9uIGV0YyBpbiBTU1JcbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIHJldHVybiBTdHJpbmcodmFsdWUpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVBdHRyaWJ1dGUoX3ZhbHVlKSB7XG4gIHZhciB2YWx1ZSA9IG5vcm1hbGl6ZUF0dHJpYnV0ZVZhbHVlKF92YWx1ZSk7XG4gIGlmIChpc0F0dHJSZW1vdmFsVmFsdWUodmFsdWUpKSB7XG4gICAgdGhpcy5kb21IZWxwZXIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSk7XG4gIH0gZWxzZSB7XG4gICAgdGhpcy5kb21IZWxwZXIuc2V0QXR0cmlidXRlKHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSwgdmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEF0dHJpYnV0ZU5TKCkge1xuICByZXR1cm4gdGhpcy5kb21IZWxwZXIuZ2V0QXR0cmlidXRlTlModGhpcy5lbGVtZW50LCB0aGlzLm5hbWVzcGFjZSwgdGhpcy5hdHRyTmFtZSk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUF0dHJpYnV0ZU5TKF92YWx1ZSkge1xuICB2YXIgdmFsdWUgPSBub3JtYWxpemVBdHRyaWJ1dGVWYWx1ZShfdmFsdWUpO1xuICBpZiAoaXNBdHRyUmVtb3ZhbFZhbHVlKHZhbHVlKSkge1xuICAgIHRoaXMuZG9tSGVscGVyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLmVsZW1lbnQsIHRoaXMuYXR0ck5hbWUpO1xuICB9IGVsc2Uge1xuICAgIHRoaXMuZG9tSGVscGVyLnNldEF0dHJpYnV0ZU5TKHRoaXMuZWxlbWVudCwgdGhpcy5uYW1lc3BhY2UsIHRoaXMuYXR0ck5hbWUsIHZhbHVlKTtcbiAgfVxufVxuXG52YXIgVU5TRVQgPSB7IHVuc2V0OiB0cnVlIH07XG5cbnZhciBndWlkID0gMTtcblxuQXR0ck1vcnBoLmNyZWF0ZSA9IGZ1bmN0aW9uKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIsIG5hbWVzcGFjZSkge1xuICBsZXQgbnMgPSBnZXRBdHRyTmFtZXNwYWNlKGF0dHJOYW1lLCBuYW1lc3BhY2UpO1xuXG4gIGlmIChucykge1xuICAgIHJldHVybiBuZXcgQXR0cmlidXRlTlNBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlciwgbnMpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBjcmVhdGVOb25OYW1lc3BhY2VkQXR0ck1vcnBoKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIpO1xuICB9XG59O1xuXG5mdW5jdGlvbiBjcmVhdGVOb25OYW1lc3BhY2VkQXR0ck1vcnBoKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIpIHtcbiAgbGV0IHsgbm9ybWFsaXplZCwgdHlwZSB9ID0gbm9ybWFsaXplUHJvcGVydHkoZWxlbWVudCwgYXR0ck5hbWUpO1xuXG4gIGlmIChlbGVtZW50Lm5hbWVzcGFjZVVSSSA9PT0gc3ZnTmFtZXNwYWNlIHx8IGF0dHJOYW1lID09PSAnc3R5bGUnIHx8IHR5cGUgPT09ICdhdHRyJykge1xuICAgIHJldHVybiBuZXcgQXR0cmlidXRlQXR0ck1vcnBoKGVsZW1lbnQsIG5vcm1hbGl6ZWQsIGRvbUhlbHBlcik7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG5ldyBQcm9wZXJ0eUF0dHJNb3JwaChlbGVtZW50LCBub3JtYWxpemVkLCBkb21IZWxwZXIpO1xuICB9XG59XG5cbmZ1bmN0aW9uIEF0dHJNb3JwaChlbGVtZW50LCBhdHRyTmFtZSwgZG9tSGVscGVyKSB7XG4gIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7XG4gIHRoaXMuZG9tSGVscGVyID0gZG9tSGVscGVyO1xuICB0aGlzLmF0dHJOYW1lID0gYXR0ck5hbWU7XG4gIHRoaXMuX3N0YXRlID0gdW5kZWZpbmVkO1xuICB0aGlzLmlzRGlydHkgPSBmYWxzZTtcbiAgdGhpcy5pc1N1YnRyZWVEaXJ0eSA9IGZhbHNlO1xuICB0aGlzLmVzY2FwZWQgPSB0cnVlO1xuICB0aGlzLmxhc3RWYWx1ZSA9IFVOU0VUO1xuICB0aGlzLmxhc3RSZXN1bHQgPSBudWxsO1xuICB0aGlzLmxhc3RZaWVsZGVkID0gbnVsbDtcbiAgdGhpcy5jaGlsZE5vZGVzID0gbnVsbDtcbiAgdGhpcy5saW5rZWRQYXJhbXMgPSBudWxsO1xuICB0aGlzLmxpbmtlZFJlc3VsdCA9IG51bGw7XG4gIHRoaXMuZ3VpZCA9IFwiYXR0clwiICsgZ3VpZCsrO1xuICB0aGlzLnNlZW4gPSBmYWxzZTtcbiAgdGhpcy5vd25lck5vZGUgPSBudWxsO1xuICB0aGlzLnJlbmRlcmVkID0gZmFsc2U7XG4gIHRoaXMuX3JlbmRlcmVkSW5pdGlhbGx5ID0gZmFsc2U7XG4gIHRoaXMubmFtZXNwYWNlID0gdW5kZWZpbmVkO1xuICB0aGlzLmRpZEluaXQoKTtcbn1cblxuQXR0ck1vcnBoLnByb3RvdHlwZS5nZXRTdGF0ZSA9IGZ1bmN0aW9uKCkge1xuICBpZiAoIXRoaXMuX3N0YXRlKSB7XG4gICAgdGhpcy5fc3RhdGUgPSB7fTtcbiAgfVxuXG4gIHJldHVybiB0aGlzLl9zdGF0ZTtcbn07XG5cbkF0dHJNb3JwaC5wcm90b3R5cGUuc2V0U3RhdGUgPSBmdW5jdGlvbihuZXdTdGF0ZSkge1xuICAvKmpzaGludCAtVzA5MyAqL1xuXG4gIHJldHVybiB0aGlzLl9zdGF0ZSA9IG5ld1N0YXRlO1xufTtcblxuQXR0ck1vcnBoLnByb3RvdHlwZS5kaWRJbml0ID0gZnVuY3Rpb24oKSB7fTtcbkF0dHJNb3JwaC5wcm90b3R5cGUud2lsbFNldENvbnRlbnQgPSBmdW5jdGlvbigpIHt9O1xuXG5BdHRyTW9ycGgucHJvdG90eXBlLnNldENvbnRlbnQgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgdGhpcy53aWxsU2V0Q29udGVudCh2YWx1ZSk7XG5cbiAgaWYgKHRoaXMubGFzdFZhbHVlID09PSB2YWx1ZSkgeyByZXR1cm47IH1cbiAgdGhpcy5sYXN0VmFsdWUgPSB2YWx1ZTtcblxuICBpZiAodGhpcy5lc2NhcGVkKSB7XG4gICAgdmFyIHNhbml0aXplZCA9IHNhbml0aXplQXR0cmlidXRlVmFsdWUodGhpcy5kb21IZWxwZXIsIHRoaXMuZWxlbWVudCwgdGhpcy5hdHRyTmFtZSwgdmFsdWUpO1xuICAgIHRoaXMuX3VwZGF0ZShzYW5pdGl6ZWQsIHRoaXMubmFtZXNwYWNlKTtcbiAgfSBlbHNlIHtcbiAgICB0aGlzLl91cGRhdGUodmFsdWUsIHRoaXMubmFtZXNwYWNlKTtcbiAgfVxufTtcblxuQXR0ck1vcnBoLnByb3RvdHlwZS5nZXRDb250ZW50ID0gZnVuY3Rpb24gKCkge1xuICB2YXIgdmFsdWUgPSB0aGlzLmxhc3RWYWx1ZSA9IHRoaXMuX2dldCgpO1xuICByZXR1cm4gdmFsdWU7XG59O1xuXG4vLyByZW5kZXJBbmRDbGVhbnVwIGNhbGxzIGBjbGVhcmAgb24gYWxsIGl0ZW1zIGluIHRoZSBtb3JwaCBtYXBcbi8vIGp1c3QgYmVmb3JlIGNhbGxpbmcgYGRlc3Ryb3lgIG9uIHRoZSBtb3JwaC5cbi8vXG4vLyBBcyBhIGZ1dHVyZSByZWZhY3RvciB0aGlzIGNvdWxkIGJlIGNoYW5nZWQgdG8gc2V0IHRoZSBwcm9wZXJ0eVxuLy8gYmFjayB0byBpdHMgb3JpZ2luYWwvZGVmYXVsdCB2YWx1ZS5cbkF0dHJNb3JwaC5wcm90b3R5cGUuY2xlYXIgPSBmdW5jdGlvbigpIHsgfTtcblxuQXR0ck1vcnBoLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuZWxlbWVudCA9IG51bGw7XG4gIHRoaXMuZG9tSGVscGVyID0gbnVsbDtcbn07XG5cbkF0dHJNb3JwaC5wcm90b3R5cGUuXyRzdXBlckF0dHJNb3JwaCA9IEF0dHJNb3JwaDtcblxuZnVuY3Rpb24gUHJvcGVydHlBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlcikge1xuICB0aGlzLl8kc3VwZXJBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlcik7XG59XG5cblByb3BlcnR5QXR0ck1vcnBoLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQXR0ck1vcnBoLnByb3RvdHlwZSk7XG5Qcm9wZXJ0eUF0dHJNb3JwaC5wcm90b3R5cGUuX3VwZGF0ZSA9IHVwZGF0ZVByb3BlcnR5O1xuUHJvcGVydHlBdHRyTW9ycGgucHJvdG90eXBlLl9nZXQgPSBnZXRQcm9wZXJ0eTtcblxuZnVuY3Rpb24gQXR0cmlidXRlTlNBdHRyTW9ycGgoZWxlbWVudCwgYXR0ck5hbWUsIGRvbUhlbHBlciwgbmFtZXNwYWNlKSB7XG4gIHRoaXMuXyRzdXBlckF0dHJNb3JwaChlbGVtZW50LCBhdHRyTmFtZSwgZG9tSGVscGVyKTtcbiAgdGhpcy5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7XG59XG5cbkF0dHJpYnV0ZU5TQXR0ck1vcnBoLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoQXR0ck1vcnBoLnByb3RvdHlwZSk7XG5BdHRyaWJ1dGVOU0F0dHJNb3JwaC5wcm90b3R5cGUuX3VwZGF0ZSA9IHVwZGF0ZUF0dHJpYnV0ZU5TO1xuQXR0cmlidXRlTlNBdHRyTW9ycGgucHJvdG90eXBlLl9nZXQgPSBnZXRBdHRyaWJ1dGVOUztcblxuZnVuY3Rpb24gQXR0cmlidXRlQXR0ck1vcnBoKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIpIHtcbiAgdGhpcy5fJHN1cGVyQXR0ck1vcnBoKGVsZW1lbnQsIGF0dHJOYW1lLCBkb21IZWxwZXIpO1xufVxuXG5BdHRyaWJ1dGVBdHRyTW9ycGgucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShBdHRyTW9ycGgucHJvdG90eXBlKTtcbkF0dHJpYnV0ZUF0dHJNb3JwaC5wcm90b3R5cGUuX3VwZGF0ZSA9IHVwZGF0ZUF0dHJpYnV0ZTtcbkF0dHJpYnV0ZUF0dHJNb3JwaC5wcm90b3R5cGUuX2dldCA9IGdldEF0dHJpYnV0ZTtcblxuZXhwb3J0IGRlZmF1bHQgQXR0ck1vcnBoO1xuXG5leHBvcnQgeyBzYW5pdGl6ZUF0dHJpYnV0ZVZhbHVlIH07XG4iXX0=