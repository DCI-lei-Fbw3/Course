exports.__esModule = true;

var _utils = require("./utils");

var _htmlbarsUtilQuoting = require("../htmlbars-util/quoting");

var _htmlbarsUtilTemplateUtils = require('../htmlbars-util/template-utils');

function HydrationJavaScriptCompiler() {
  this.stack = [];
  this.source = [];
  this.mustaches = [];
  this.parents = [['fragment']];
  this.parentCount = 0;
  this.morphs = [];
  this.fragmentProcessing = [];
  this.hooks = undefined;
}

exports.default = HydrationJavaScriptCompiler;

var prototype = HydrationJavaScriptCompiler.prototype;

prototype.compile = function (opcodes, options) {
  this.stack.length = 0;
  this.mustaches.length = 0;
  this.source.length = 0;
  this.parents.length = 1;
  this.parents[0] = ['fragment'];
  this.morphs.length = 0;
  this.fragmentProcessing.length = 0;
  this.parentCount = 0;
  this.indent = options && options.indent || "";
  this.hooks = {};
  this.hasOpenBoundary = false;
  this.hasCloseBoundary = false;
  this.statements = [];
  this.expressionStack = [];
  this.locals = [];
  this.hasOpenBoundary = false;
  this.hasCloseBoundary = false;

  _utils.processOpcodes(this, opcodes);

  if (this.hasOpenBoundary) {
    this.source.unshift(this.indent + "  dom.insertBoundary(fragment, 0);\n");
  }

  if (this.hasCloseBoundary) {
    this.source.unshift(this.indent + "  dom.insertBoundary(fragment, null);\n");
  }

  var i, l;

  var indent = this.indent;

  var morphs;

  var result = {
    createMorphsProgram: '',
    hydrateMorphsProgram: '',
    fragmentProcessingProgram: '',
    statements: this.statements,
    locals: this.locals,
    hasMorphs: false
  };

  result.hydrateMorphsProgram = this.source.join('');

  if (this.morphs.length) {
    result.hasMorphs = true;
    morphs = indent + '  var morphs = new Array(' + this.morphs.length + ');\n';

    for (i = 0, l = this.morphs.length; i < l; ++i) {
      var morph = this.morphs[i];
      morphs += indent + '  morphs[' + i + '] = ' + morph + ';\n';
    }
  }

  if (this.fragmentProcessing.length) {
    var processing = "";
    for (i = 0, l = this.fragmentProcessing.length; i < l; ++i) {
      processing += this.indent + '  ' + this.fragmentProcessing[i] + '\n';
    }
    result.fragmentProcessingProgram = processing;
  }

  var createMorphsProgram;
  if (result.hasMorphs) {
    createMorphsProgram = 'function buildRenderNodes(dom, fragment, contextualElement) {\n' + result.fragmentProcessingProgram + morphs;

    if (this.hasOpenBoundary) {
      createMorphsProgram += indent + "  dom.insertBoundary(fragment, 0);\n";
    }

    if (this.hasCloseBoundary) {
      createMorphsProgram += indent + "  dom.insertBoundary(fragment, null);\n";
    }

    createMorphsProgram += indent + '  return morphs;\n' + indent + '}';
  } else {
    createMorphsProgram = 'function buildRenderNodes() { return []; }';
  }

  result.createMorphsProgram = createMorphsProgram;

  return result;
};

prototype.prepareArray = function (length) {
  var values = [];

  for (var i = 0; i < length; i++) {
    values.push(this.expressionStack.pop());
  }

  this.expressionStack.push(values);
};

prototype.prepareObject = function (size) {
  var pairs = [];

  for (var i = 0; i < size; i++) {
    pairs.push(this.expressionStack.pop(), this.expressionStack.pop());
  }

  this.expressionStack.push(pairs);
};

prototype.openBoundary = function () {
  this.hasOpenBoundary = true;
};

prototype.closeBoundary = function () {
  this.hasCloseBoundary = true;
};

prototype.pushLiteral = function (value) {
  this.expressionStack.push(value);
};

prototype.pushGetHook = function (path, meta) {
  this.expressionStack.push(_htmlbarsUtilTemplateUtils.buildStatement('get', path, meta));
};

prototype.pushSexprHook = function (meta) {
  var statement = _htmlbarsUtilTemplateUtils.buildStatement('subexpr', this.expressionStack.pop(), this.expressionStack.pop(), this.expressionStack.pop(), meta);

  this.expressionStack.push(statement);
};

prototype.pushConcatHook = function () {
  this.expressionStack.push(_htmlbarsUtilTemplateUtils.buildStatement('concat', this.expressionStack.pop()));
};

prototype.printSetHook = function (name) {
  this.locals.push(name);
};

prototype.printBlockHook = function (templateId, inverseId, meta) {
  this.pushStatement('block', this.expressionStack.pop(), // path
  this.expressionStack.pop(), // params
  this.expressionStack.pop(), // hash
  templateId, inverseId, meta);
};

prototype.printInlineHook = function (meta) {
  var path = this.expressionStack.pop();
  var params = this.expressionStack.pop();
  var hash = this.expressionStack.pop();

  this.pushStatement('inline', path, params, hash, meta);
};

prototype.printContentHook = function (meta) {
  this.pushStatement('content', this.expressionStack.pop(), meta);
};

prototype.printComponentHook = function (templateId) {
  this.pushStatement('component', this.expressionStack.pop(), // path
  this.expressionStack.pop(), // attrs
  templateId);
};

prototype.printAttributeHook = function () {
  this.pushStatement('attribute', this.expressionStack.pop(), // name
  this.expressionStack.pop() // value;
  );
};

prototype.printElementHook = function (meta) {
  this.pushStatement('element', this.expressionStack.pop(), // path
  this.expressionStack.pop(), // params
  this.expressionStack.pop(), // hash
  meta);
};

prototype.createMorph = function (morphNum, parentPath, startIndex, endIndex, escaped) {
  var isRoot = parentPath.length === 0;
  var parent = this.getParent();

  var morphMethod = escaped ? 'createMorphAt' : 'createUnsafeMorphAt';
  var morph = "dom." + morphMethod + "(" + parent + "," + (startIndex === null ? "-1" : startIndex) + "," + (endIndex === null ? "-1" : endIndex) + (isRoot ? ",contextualElement)" : ")");

  this.morphs[morphNum] = morph;
};

prototype.createAttrMorph = function (attrMorphNum, elementNum, name, escaped, namespace) {
  var morphMethod = escaped ? 'createAttrMorph' : 'createUnsafeAttrMorph';
  var morph = "dom." + morphMethod + "(element" + elementNum + ", '" + name + (namespace ? "', '" + namespace : '') + "')";
  this.morphs[attrMorphNum] = morph;
};

prototype.createElementMorph = function (morphNum, elementNum) {
  var morphMethod = 'createElementMorph';
  var morph = "dom." + morphMethod + "(element" + elementNum + ")";
  this.morphs[morphNum] = morph;
};

prototype.repairClonedNode = function (blankChildTextNodes, isElementChecked) {
  var parent = this.getParent(),
      processing = 'if (this.cachedFragment) { dom.repairClonedNode(' + parent + ',' + _htmlbarsUtilQuoting.array(blankChildTextNodes) + (isElementChecked ? ',true' : '') + '); }';
  this.fragmentProcessing.push(processing);
};

prototype.shareElement = function (elementNum) {
  var elementNodesName = "element" + elementNum;
  this.fragmentProcessing.push('var ' + elementNodesName + ' = ' + this.getParent() + ';');
  this.parents[this.parents.length - 1] = [elementNodesName];
};

prototype.consumeParent = function (i) {
  var newParent = this.lastParent().slice();
  newParent.push(i);

  this.parents.push(newParent);
};

prototype.popParent = function () {
  this.parents.pop();
};

prototype.getParent = function () {
  var last = this.lastParent().slice();
  var frag = last.shift();

  if (!last.length) {
    return frag;
  }

  return 'dom.childAt(' + frag + ', [' + last.join(', ') + '])';
};

prototype.lastParent = function () {
  return this.parents[this.parents.length - 1];
};

prototype.pushStatement = function () {
  this.statements.push(_htmlbarsUtilTemplateUtils.buildStatement.apply(undefined, arguments));
};
module.exports = exports.default;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLWNvbXBpbGVyL2h5ZHJhdGlvbi1qYXZhc2NyaXB0LWNvbXBpbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O3FCQUErQixTQUFTOzttQ0FDbEIsMEJBQTBCOzt5Q0FDakIsaUNBQWlDOztBQUVoRSxTQUFTLDJCQUEyQixHQUFHO0FBQ3JDLE1BQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBQ2hCLE1BQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLE1BQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLE1BQUksQ0FBQyxPQUFPLEdBQUcsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDOUIsTUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDckIsTUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDakIsTUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztBQUM3QixNQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQztDQUN4Qjs7a0JBRWMsMkJBQTJCOztBQUUxQyxJQUFJLFNBQVMsR0FBRywyQkFBMkIsQ0FBQyxTQUFTLENBQUM7O0FBRXRELFNBQVMsQ0FBQyxPQUFPLEdBQUcsVUFBUyxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQzdDLE1BQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN0QixNQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUN4QixNQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDL0IsTUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLE1BQUksQ0FB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LElBQUksQ0FBQztDQUMvRCxDQUFDOztBQUVGLFNBQVMsQ0FBQyxVQUFVLEdBQUcsWUFBVztBQUNoQyxTQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDNUMsQ0FBQzs7QUFFRixTQUFTLENBQUMsYUFBYSxHQUFHLFlBQVc7QUFDbkMsTUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsMkRBQWtCLFNBQVMsQ0FBQyxDQUFDLENBQUM7Q0FDcEQsQ0FBQyIsImZpbGUiOiJodG1sYmFycy1jb21waWxlci9oeWRyYXRpb24tamF2YXNjcmlwdC1jb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHByb2Nlc3NPcGNvZGVzIH0gZnJvbSBcIi4vdXRpbHNcIjtcbmltcG9ydCB7IGFycmF5IH0gZnJvbSBcIi4uL2h0bWxiYXJzLXV0aWwvcXVvdGluZ1wiO1xuaW1wb3J0IHsgYnVpbGRTdGF0ZW1lbnQgfSBmcm9tICcuLi9odG1sYmFycy11dGlsL3RlbXBsYXRlLXV0aWxzJztcblxuZnVuY3Rpb24gSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyKCkge1xuICB0aGlzLnN0YWNrID0gW107XG4gIHRoaXMuc291cmNlID0gW107XG4gIHRoaXMubXVzdGFjaGVzID0gW107XG4gIHRoaXMucGFyZW50cyA9IFtbJ2ZyYWdtZW50J11dO1xuICB0aGlzLnBhcmVudENvdW50ID0gMDtcbiAgdGhpcy5tb3JwaHMgPSBbXTtcbiAgdGhpcy5mcmFnbWVudFByb2Nlc3NpbmcgPSBbXTtcbiAgdGhpcy5ob29rcyA9IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyO1xuXG52YXIgcHJvdG90eXBlID0gSHlkcmF0aW9uSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZTtcblxucHJvdG90eXBlLmNvbXBpbGUgPSBmdW5jdGlvbihvcGNvZGVzLCBvcHRpb25zKSB7XG4gIHRoaXMuc3RhY2subGVuZ3RoID0gMDtcbiAgdGhpcy5tdXN0YWNoZXMubGVuZ3RoID0gMDtcbiAgdGhpcy5zb3VyY2UubGVuZ3RoID0gMDtcbiAgdGhpcy5wYXJlbnRzLmxlbmd0aCA9IDE7XG4gIHRoaXMucGFyZW50c1swXSA9IFsnZnJhZ21lbnQnXTtcbiAgdGhpcy5tb3JwaHMubGVuZ3RoID0gMDtcbiAgdGhpcy5mcmFnbWVudFByb2Nlc3NpbmcubGVuZ3RoID0gMDtcbiAgdGhpcy5wYXJlbnRDb3VudCA9IDA7XG4gIHRoaXMuaW5kZW50ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5pbmRlbnQpIHx8IFwiXCI7XG4gIHRoaXMuaG9va3MgPSB7fTtcbiAgdGhpcy5oYXNPcGVuQm91bmRhcnkgPSBmYWxzZTtcbiAgdGhpcy5oYXNDbG9zZUJvdW5kYXJ5ID0gZmFsc2U7XG4gIHRoaXMuc3RhdGVtZW50cyA9IFtdO1xuICB0aGlzLmV4cHJlc3Npb25TdGFjayA9IFtdO1xuICB0aGlzLmxvY2FscyA9IFtdO1xuICB0aGlzLmhhc09wZW5Cb3VuZGFyeSA9IGZhbHNlO1xuICB0aGlzLmhhc0Nsb3NlQm91bmRhcnkgPSBmYWxzZTtcblxuICBwcm9jZXNzT3Bjb2Rlcyh0aGlzLCBvcGNvZGVzKTtcblxuICBpZiAodGhpcy5oYXNPcGVuQm91bmRhcnkpIHtcbiAgICB0aGlzLnNvdXJjZS51bnNoaWZ0KHRoaXMuaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIDApO1xcblwiKTtcbiAgfVxuXG4gIGlmICh0aGlzLmhhc0Nsb3NlQm91bmRhcnkpIHtcbiAgICB0aGlzLnNvdXJjZS51bnNoaWZ0KHRoaXMuaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIG51bGwpO1xcblwiKTtcbiAgfVxuXG4gIHZhciBpLCBsO1xuXG4gIHZhciBpbmRlbnQgPSB0aGlzLmluZGVudDtcblxuICB2YXIgbW9ycGhzO1xuXG4gIHZhciByZXN1bHQgPSB7XG4gICAgY3JlYXRlTW9ycGhzUHJvZ3JhbTogJycsXG4gICAgaHlkcmF0ZU1vcnBoc1Byb2dyYW06ICcnLFxuICAgIGZyYWdtZW50UHJvY2Vzc2luZ1Byb2dyYW06ICcnLFxuICAgIHN0YXRlbWVudHM6IHRoaXMuc3RhdGVtZW50cyxcbiAgICBsb2NhbHM6IHRoaXMubG9jYWxzLFxuICAgIGhhc01vcnBoczogZmFsc2VcbiAgfTtcblxuICByZXN1bHQuaHlkcmF0ZU1vcnBoc1Byb2dyYW0gPSB0aGlzLnNvdXJjZS5qb2luKCcnKTtcblxuICBpZiAodGhpcy5tb3JwaHMubGVuZ3RoKSB7XG4gICAgcmVzdWx0Lmhhc01vcnBocyA9IHRydWU7XG4gICAgbW9ycGhzID1cbiAgICAgIGluZGVudCsnICB2YXIgbW9ycGhzID0gbmV3IEFycmF5KCcgKyB0aGlzLm1vcnBocy5sZW5ndGggKyAnKTtcXG4nO1xuXG4gICAgICBmb3IgKGkgPSAwLCBsID0gdGhpcy5tb3JwaHMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICAgIHZhciBtb3JwaCA9IHRoaXMubW9ycGhzW2ldO1xuICAgICAgICBtb3JwaHMgKz0gaW5kZW50KycgIG1vcnBoc1snK2krJ10gPSAnK21vcnBoKyc7XFxuJztcbiAgICAgIH1cbiAgfVxuXG4gIGlmICh0aGlzLmZyYWdtZW50UHJvY2Vzc2luZy5sZW5ndGgpIHtcbiAgICB2YXIgcHJvY2Vzc2luZyA9IFwiXCI7XG4gICAgZm9yIChpID0gMCwgbCA9IHRoaXMuZnJhZ21lbnRQcm9jZXNzaW5nLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgcHJvY2Vzc2luZyArPSB0aGlzLmluZGVudCsnICAnK3RoaXMuZnJhZ21lbnRQcm9jZXNzaW5nW2ldKydcXG4nO1xuICAgIH1cbiAgICByZXN1bHQuZnJhZ21lbnRQcm9jZXNzaW5nUHJvZ3JhbSA9IHByb2Nlc3Npbmc7XG4gIH1cblxuICB2YXIgY3JlYXRlTW9ycGhzUHJvZ3JhbTtcbiAgaWYgKHJlc3VsdC5oYXNNb3JwaHMpIHtcbiAgICBjcmVhdGVNb3JwaHNQcm9ncmFtID1cbiAgICAgICdmdW5jdGlvbiBidWlsZFJlbmRlck5vZGVzKGRvbSwgZnJhZ21lbnQsIGNvbnRleHR1YWxFbGVtZW50KSB7XFxuJyArXG4gICAgICByZXN1bHQuZnJhZ21lbnRQcm9jZXNzaW5nUHJvZ3JhbSArIG1vcnBocztcblxuICAgICAgaWYgKHRoaXMuaGFzT3BlbkJvdW5kYXJ5KSB7XG4gICAgICAgIGNyZWF0ZU1vcnBoc1Byb2dyYW0gKz0gaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIDApO1xcblwiO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oYXNDbG9zZUJvdW5kYXJ5KSB7XG4gICAgICAgIGNyZWF0ZU1vcnBoc1Byb2dyYW0gKz0gaW5kZW50K1wiICBkb20uaW5zZXJ0Qm91bmRhcnkoZnJhZ21lbnQsIG51bGwpO1xcblwiO1xuICAgICAgfVxuXG4gICAgICBjcmVhdGVNb3JwaHNQcm9ncmFtICs9XG4gICAgICBpbmRlbnQgKyAnICByZXR1cm4gbW9ycGhzO1xcbicgK1xuICAgICAgaW5kZW50Kyd9JztcbiAgfSBlbHNlIHtcbiAgICBjcmVhdGVNb3JwaHNQcm9ncmFtID1cbiAgICAgICdmdW5jdGlvbiBidWlsZFJlbmRlck5vZGVzKCkgeyByZXR1cm4gW107IH0nO1xuICB9XG5cbiAgcmVzdWx0LmNyZWF0ZU1vcnBoc1Byb2dyYW0gPSBjcmVhdGVNb3JwaHNQcm9ncmFtO1xuXG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5wcm90b3R5cGUucHJlcGFyZUFycmF5ID0gZnVuY3Rpb24obGVuZ3RoKSB7XG4gIHZhciB2YWx1ZXMgPSBbXTtcblxuICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgdmFsdWVzLnB1c2godGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCkpO1xuICB9XG5cbiAgdGhpcy5leHByZXNzaW9uU3RhY2sucHVzaCh2YWx1ZXMpO1xufTtcblxucHJvdG90eXBlLnByZXBhcmVPYmplY3QgPSBmdW5jdGlvbihzaXplKSB7XG4gIHZhciBwYWlycyA9IFtdO1xuXG4gIGZvciAodmFyIGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgcGFpcnMucHVzaCh0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCkpO1xuICB9XG5cbiAgdGhpcy5leHByZXNzaW9uU3RhY2sucHVzaChwYWlycyk7XG59O1xuXG5wcm90b3R5cGUub3BlbkJvdW5kYXJ5ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuaGFzT3BlbkJvdW5kYXJ5ID0gdHJ1ZTtcbn07XG5cbnByb3RvdHlwZS5jbG9zZUJvdW5kYXJ5ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuaGFzQ2xvc2VCb3VuZGFyeSA9IHRydWU7XG59O1xuXG5wcm90b3R5cGUucHVzaExpdGVyYWwgPSBmdW5jdGlvbih2YWx1ZSkge1xuICB0aGlzLmV4cHJlc3Npb25TdGFjay5wdXNoKHZhbHVlKTtcbn07XG5cbnByb3RvdHlwZS5wdXNoR2V0SG9vayA9IGZ1bmN0aW9uKHBhdGgsIG1ldGEpIHtcbiAgdGhpcy5leHByZXNzaW9uU3RhY2sucHVzaChidWlsZFN0YXRlbWVudCgnZ2V0JywgcGF0aCwgbWV0YSkpO1xufTtcblxucHJvdG90eXBlLnB1c2hTZXhwckhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIGxldCBzdGF0ZW1lbnQgPSBidWlsZFN0YXRlbWVudChcbiAgICAnc3ViZXhwcicsXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksXG4gICAgbWV0YVxuICApO1xuXG4gIHRoaXMuZXhwcmVzc2lvblN0YWNrLnB1c2goc3RhdGVtZW50KTtcbn07XG5cbnByb3RvdHlwZS5wdXNoQ29uY2F0SG9vayA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLmV4cHJlc3Npb25TdGFjay5wdXNoKGJ1aWxkU3RhdGVtZW50KCdjb25jYXQnLCB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSkpO1xufTtcblxucHJvdG90eXBlLnByaW50U2V0SG9vayA9IGZ1bmN0aW9uKG5hbWUpIHtcbiAgdGhpcy5sb2NhbHMucHVzaChuYW1lKTtcbn07XG5cbnByb3RvdHlwZS5wcmludEJsb2NrSG9vayA9IGZ1bmN0aW9uKHRlbXBsYXRlSWQsIGludmVyc2VJZCwgbWV0YSkge1xuICB0aGlzLnB1c2hTdGF0ZW1lbnQoXG4gICAgJ2Jsb2NrJyxcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgLy8gcGF0aFxuICAgIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCAvLyBwYXJhbXNcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgLy8gaGFzaFxuICAgIHRlbXBsYXRlSWQsXG4gICAgaW52ZXJzZUlkLFxuICAgIG1ldGFcbiAgKTtcbn07XG5cbnByb3RvdHlwZS5wcmludElubGluZUhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIHZhciBwYXRoID0gdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCk7XG4gIHZhciBwYXJhbXMgPSB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKTtcbiAgdmFyIGhhc2ggPSB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKTtcblxuICB0aGlzLnB1c2hTdGF0ZW1lbnQoICdpbmxpbmUnLCBwYXRoLCBwYXJhbXMsIGhhc2gsIG1ldGEpO1xufTtcblxucHJvdG90eXBlLnByaW50Q29udGVudEhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIHRoaXMucHVzaFN0YXRlbWVudCgnY29udGVudCcsIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCBtZXRhKTtcbn07XG5cbnByb3RvdHlwZS5wcmludENvbXBvbmVudEhvb2sgPSBmdW5jdGlvbih0ZW1wbGF0ZUlkKSB7XG4gIHRoaXMucHVzaFN0YXRlbWVudChcbiAgICAnY29tcG9uZW50JyxcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgLy8gcGF0aFxuICAgIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCAvLyBhdHRyc1xuICAgIHRlbXBsYXRlSWRcbiAgKTtcbn07XG5cbnByb3RvdHlwZS5wcmludEF0dHJpYnV0ZUhvb2sgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5wdXNoU3RhdGVtZW50KFxuICAgICdhdHRyaWJ1dGUnLFxuICAgIHRoaXMuZXhwcmVzc2lvblN0YWNrLnBvcCgpLCAvLyBuYW1lXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCkgIC8vIHZhbHVlO1xuICApO1xufTtcblxucHJvdG90eXBlLnByaW50RWxlbWVudEhvb2sgPSBmdW5jdGlvbihtZXRhKSB7XG4gIHRoaXMucHVzaFN0YXRlbWVudChcbiAgICAnZWxlbWVudCcsXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIHBhdGhcbiAgICB0aGlzLmV4cHJlc3Npb25TdGFjay5wb3AoKSwgLy8gcGFyYW1zXG4gICAgdGhpcy5leHByZXNzaW9uU3RhY2sucG9wKCksIC8vIGhhc2hcbiAgICBtZXRhXG4gICk7XG59O1xuXG5wcm90b3R5cGUuY3JlYXRlTW9ycGggPSBmdW5jdGlvbihtb3JwaE51bSwgcGFyZW50UGF0aCwgc3RhcnRJbmRleCwgZW5kSW5kZXgsIGVzY2FwZWQpIHtcbiAgdmFyIGlzUm9vdCA9IHBhcmVudFBhdGgubGVuZ3RoID09PSAwO1xuICB2YXIgcGFyZW50ID0gdGhpcy5nZXRQYXJlbnQoKTtcblxuICB2YXIgbW9ycGhNZXRob2QgPSBlc2NhcGVkID8gJ2NyZWF0ZU1vcnBoQXQnIDogJ2NyZWF0ZVVuc2FmZU1vcnBoQXQnO1xuICB2YXIgbW9ycGggPSBcImRvbS5cIittb3JwaE1ldGhvZCtcIihcIitwYXJlbnQrXG4gICAgXCIsXCIrKHN0YXJ0SW5kZXggPT09IG51bGwgPyBcIi0xXCIgOiBzdGFydEluZGV4KStcbiAgICBcIixcIisoZW5kSW5kZXggPT09IG51bGwgPyBcIi0xXCIgOiBlbmRJbmRleCkrXG4gICAgKGlzUm9vdCA/IFwiLGNvbnRleHR1YWxFbGVtZW50KVwiIDogXCIpXCIpO1xuXG4gIHRoaXMubW9ycGhzW21vcnBoTnVtXSA9IG1vcnBoO1xufTtcblxucHJvdG90eXBlLmNyZWF0ZUF0dHJNb3JwaCA9IGZ1bmN0aW9uKGF0dHJNb3JwaE51bSwgZWxlbWVudE51bSwgbmFtZSwgZXNjYXBlZCwgbmFtZXNwYWNlKSB7XG4gIHZhciBtb3JwaE1ldGhvZCA9IGVzY2FwZWQgPyAnY3JlYXRlQXR0ck1vcnBoJyA6ICdjcmVhdGVVbnNhZmVBdHRyTW9ycGgnO1xuICB2YXIgbW9ycGggPSBcImRvbS5cIittb3JwaE1ldGhvZCtcIihlbGVtZW50XCIrZWxlbWVudE51bStcIiwgJ1wiK25hbWUrKG5hbWVzcGFjZSA/IFwiJywgJ1wiK25hbWVzcGFjZSA6ICcnKStcIicpXCI7XG4gIHRoaXMubW9ycGhzW2F0dHJNb3JwaE51bV0gPSBtb3JwaDtcbn07XG5cbnByb3RvdHlwZS5jcmVhdGVFbGVtZW50TW9ycGggPSBmdW5jdGlvbihtb3JwaE51bSwgZWxlbWVudE51bSApIHtcbiAgdmFyIG1vcnBoTWV0aG9kID0gJ2NyZWF0ZUVsZW1lbnRNb3JwaCc7XG4gIHZhciBtb3JwaCA9IFwiZG9tLlwiK21vcnBoTWV0aG9kK1wiKGVsZW1lbnRcIitlbGVtZW50TnVtK1wiKVwiO1xuICB0aGlzLm1vcnBoc1ttb3JwaE51bV0gPSBtb3JwaDtcbn07XG5cbnByb3RvdHlwZS5yZXBhaXJDbG9uZWROb2RlID0gZnVuY3Rpb24oYmxhbmtDaGlsZFRleHROb2RlcywgaXNFbGVtZW50Q2hlY2tlZCkge1xuICB2YXIgcGFyZW50ID0gdGhpcy5nZXRQYXJlbnQoKSxcbiAgICAgIHByb2Nlc3NpbmcgPSAnaWYgKHRoaXMuY2FjaGVkRnJhZ21lbnQpIHsgZG9tLnJlcGFpckNsb25lZE5vZGUoJytwYXJlbnQrJywnK1xuICAgICAgICAgICAgICAgICAgIGFycmF5KGJsYW5rQ2hpbGRUZXh0Tm9kZXMpK1xuICAgICAgICAgICAgICAgICAgICggaXNFbGVtZW50Q2hlY2tlZCA/ICcsdHJ1ZScgOiAnJyApK1xuICAgICAgICAgICAgICAgICAgICcpOyB9JztcbiAgdGhpcy5mcmFnbWVudFByb2Nlc3NpbmcucHVzaChcbiAgICBwcm9jZXNzaW5nXG4gICk7XG59O1xuXG5wcm90b3R5cGUuc2hhcmVFbGVtZW50ID0gZnVuY3Rpb24oZWxlbWVudE51bSl7XG4gIHZhciBlbGVtZW50Tm9kZXNOYW1lID0gXCJlbGVtZW50XCIgKyBlbGVtZW50TnVtO1xuICB0aGlzLmZyYWdtZW50UHJvY2Vzc2luZy5wdXNoKCd2YXIgJytlbGVtZW50Tm9kZXNOYW1lKycgPSAnK3RoaXMuZ2V0UGFyZW50KCkrJzsnKTtcbiAgdGhpcy5wYXJlbnRzW3RoaXMucGFyZW50cy5sZW5ndGgtMV0gPSBbZWxlbWVudE5vZGVzTmFtZV07XG59O1xuXG5wcm90b3R5cGUuY29uc3VtZVBhcmVudCA9IGZ1bmN0aW9uKGkpIHtcbiAgdmFyIG5ld1BhcmVudCA9IHRoaXMubGFzdFBhcmVudCgpLnNsaWNlKCk7XG4gIG5ld1BhcmVudC5wdXNoKGkpO1xuXG4gIHRoaXMucGFyZW50cy5wdXNoKG5ld1BhcmVudCk7XG59O1xuXG5wcm90b3R5cGUucG9wUGFyZW50ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMucGFyZW50cy5wb3AoKTtcbn07XG5cbnByb3RvdHlwZS5nZXRQYXJlbnQgPSBmdW5jdGlvbigpIHtcbiAgdmFyIGxhc3QgPSB0aGlzLmxhc3RQYXJlbnQoKS5zbGljZSgpO1xuICB2YXIgZnJhZyA9IGxhc3Quc2hpZnQoKTtcblxuICBpZiAoIWxhc3QubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGZyYWc7XG4gIH1cblxuICByZXR1cm4gJ2RvbS5jaGlsZEF0KCcgKyBmcmFnICsgJywgWycgKyBsYXN0LmpvaW4oJywgJykgKyAnXSknO1xufTtcblxucHJvdG90eXBlLmxhc3RQYXJlbnQgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIHRoaXMucGFyZW50c1t0aGlzLnBhcmVudHMubGVuZ3RoLTFdO1xufTtcblxucHJvdG90eXBlLnB1c2hTdGF0ZW1lbnQgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goYnVpbGRTdGF0ZW1lbnQoLi4uYXJndW1lbnRzKSk7XG59O1xuIl19