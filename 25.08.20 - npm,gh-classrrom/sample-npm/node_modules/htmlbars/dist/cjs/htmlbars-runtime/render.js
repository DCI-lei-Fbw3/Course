exports.__esModule = true;
exports.default = render;
exports.RenderOptions = RenderOptions;
exports.manualElement = manualElement;
exports.attachAttributes = attachAttributes;
exports.createChildMorph = createChildMorph;
exports.getCachedFragment = getCachedFragment;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

var _htmlbarsUtilMorphUtils = require("../htmlbars-util/morph-utils");

var _nodeVisitor = require("./node-visitor");

var _nodeVisitor2 = _interopRequireDefault(_nodeVisitor);

var _morph = require("./morph");

var _morph2 = _interopRequireDefault(_morph);

var _htmlbarsUtilTemplateUtils = require("../htmlbars-util/template-utils");

var _htmlbarsUtilVoidTagNames = require('../htmlbars-util/void-tag-names');

var _htmlbarsUtilVoidTagNames2 = _interopRequireDefault(_htmlbarsUtilVoidTagNames);

var svgNamespace = "http://www.w3.org/2000/svg";

function render(template, env, scope, options) {
  var dom = env.dom;
  var contextualElement;

  if (options) {
    if (options.renderNode) {
      contextualElement = options.renderNode.contextualElement;
    } else if (options.contextualElement) {
      contextualElement = options.contextualElement;
    }
  }

  dom.detectNamespace(contextualElement);

  var renderResult = RenderResult.build(env, scope, template, options, contextualElement);
  renderResult.render();

  return renderResult;
}

function RenderOptions(renderNode, self, blockArguments, contextualElement) {
  this.renderNode = renderNode || null;
  this.self = self;
  this.blockArguments = blockArguments || null;
  this.contextualElement = contextualElement || null;
}

function RenderResult(env, scope, options, rootNode, ownerNode, nodes, fragment, template, shouldSetContent) {
  this.root = rootNode;
  this.fragment = fragment;

  this.nodes = nodes;
  this.template = template;
  this.statements = template.statements.slice();
  this.env = env;
  this.scope = scope;
  this.shouldSetContent = shouldSetContent;

  if (options.self !== undefined) {
    this.bindSelf(options.self);
  }
  if (options.blockArguments !== undefined) {
    this.bindLocals(options.blockArguments);
  }

  this.initializeNodes(ownerNode);
}

RenderResult.build = function (env, scope, template, options, contextualElement) {
  var dom = env.dom;
  var fragment = getCachedFragment(template, env);
  var nodes = template.buildRenderNodes(dom, fragment, contextualElement);

  var rootNode, ownerNode, shouldSetContent;

  if (options && options.renderNode) {
    rootNode = options.renderNode;
    ownerNode = rootNode.ownerNode;
    shouldSetContent = true;
  } else {
    rootNode = dom.createMorph(null, fragment.firstChild, fragment.lastChild, contextualElement);
    ownerNode = rootNode;
    rootNode.ownerNode = ownerNode;
    shouldSetContent = false;
  }

  if (rootNode.childNodes) {
    _htmlbarsUtilMorphUtils.visitChildren(rootNode.childNodes, function (node) {
      _htmlbarsUtilTemplateUtils.clearMorph(node, env, true);
    });
  }

  rootNode.childNodes = nodes;
  return new RenderResult(env, scope, options, rootNode, ownerNode, nodes, fragment, template, shouldSetContent);
};

function manualElement(tagName, attributes, _isEmpty) {
  var statements = [];

  for (var key in attributes) {
    if (typeof attributes[key] === 'string') {
      continue;
    }

    statements.push(_htmlbarsUtilTemplateUtils.buildStatement("attribute", key, attributes[key]));
  }

  var isEmpty = _isEmpty || _htmlbarsUtilVoidTagNames2.default[tagName];

  if (!isEmpty) {
    statements.push(_htmlbarsUtilTemplateUtils.buildStatement('content', 'yield'));
  }

  var template = {
    arity: 0,
    cachedFragment: null,
    hasRendered: false,
    buildFragment: function buildFragment(dom) {
      var el0 = dom.createDocumentFragment();
      if (tagName === 'svg') {
        dom.setNamespace(svgNamespace);
      }
      var el1 = dom.createElement(tagName);

      for (var key in attributes) {
        if (typeof attributes[key] !== 'string') {
          continue;
        }
        dom.setAttribute(el1, key, attributes[key]);
      }

      if (!isEmpty) {
        var el2 = dom.createComment("");
        dom.appendChild(el1, el2);
      }

      dom.appendChild(el0, el1);

      return el0;
    },
    buildRenderNodes: function buildRenderNodes(dom, fragment) {
      var element = dom.childAt(fragment, [0]);
      var morphs = [];

      for (var key in attributes) {
        if (typeof attributes[key] === 'string') {
          continue;
        }
        morphs.push(dom.createAttrMorph(element, key));
      }

      if (!isEmpty) {
        morphs.push(dom.createMorphAt(element, 0, 0));
      }

      return morphs;
    },
    statements: statements,
    locals: [],
    templates: []
  };

  return template;
}

function attachAttributes(attributes) {
  var statements = [];

  for (var key in attributes) {
    if (typeof attributes[key] === 'string') {
      continue;
    }
    statements.push(_htmlbarsUtilTemplateUtils.buildStatement("attribute", key, attributes[key]));
  }

  var template = {
    arity: 0,
    cachedFragment: null,
    hasRendered: false,
    buildFragment: function buildFragment(dom) {
      var el0 = this.element;
      if (el0.namespaceURI === "http://www.w3.org/2000/svg") {
        dom.setNamespace(svgNamespace);
      }
      for (var key in attributes) {
        if (typeof attributes[key] !== 'string') {
          continue;
        }
        dom.setAttribute(el0, key, attributes[key]);
      }

      return el0;
    },
    buildRenderNodes: function buildRenderNodes(dom) {
      var element = this.element;
      var morphs = [];

      for (var key in attributes) {
        if (typeof attributes[key] === 'string') {
          continue;
        }
        morphs.push(dom.createAttrMorph(element, key));
      }

      return morphs;
    },
    statements: statements,
    locals: [],
    templates: [],
    element: null
  };

  return template;
}

RenderResult.prototype.initializeNodes = function (ownerNode) {
  var childNodes = this.root.childNodes;

  for (var i = 0, l = childNodes.length; i < l; i++) {
    childNodes[i].ownerNode = ownerNode;
  }
};

RenderResult.prototype.render = function () {
  this.root.lastResult = this;
  this.root.rendered = true;
  this.populateNodes(_nodeVisitor.AlwaysDirtyVisitor);

  if (this.shouldSetContent && this.root.setContent) {
    this.root.setContent(this.fragment);
  }
};

RenderResult.prototype.dirty = function () {
  _htmlbarsUtilMorphUtils.visitChildren([this.root], function (node) {
    node.isDirty = true;
  });
};

RenderResult.prototype.revalidate = function (env, self, blockArguments, scope) {
  this.revalidateWith(env, scope, self, blockArguments, _nodeVisitor2.default);
};

RenderResult.prototype.rerender = function (env, self, blockArguments, scope) {
  this.revalidateWith(env, scope, self, blockArguments, _nodeVisitor.AlwaysDirtyVisitor);
};

RenderResult.prototype.revalidateWith = function (env, scope, self, blockArguments, visitor) {
  if (env !== undefined) {
    this.env = env;
  }
  if (scope !== undefined) {
    this.scope = scope;
  }
  this.updateScope();

  if (self !== undefined) {
    this.updateSelf(self);
  }
  if (blockArguments !== undefined) {
    this.updateLocals(blockArguments);
  }

  this.populateNodes(visitor);
};

RenderResult.prototype.destroy = function () {
  var rootNode = this.root;
  _htmlbarsUtilTemplateUtils.clearMorph(rootNode, this.env, true);
};

RenderResult.prototype.populateNodes = function (visitor) {
  var env = this.env;
  var scope = this.scope;
  var template = this.template;
  var nodes = this.nodes;
  var statements = this.statements;
  var i, l;

  for (i = 0, l = statements.length; i < l; i++) {
    var statement = statements[i];
    var morph = nodes[i];

    if (env.hooks.willRenderNode) {
      env.hooks.willRenderNode(morph, env, scope);
    }

    switch (statement[0]) {
      case 'block':
        visitor.block(statement, morph, env, scope, template, visitor);break;
      case 'inline':
        visitor.inline(statement, morph, env, scope, visitor);break;
      case 'content':
        visitor.content(statement, morph, env, scope, visitor);break;
      case 'element':
        visitor.element(statement, morph, env, scope, template, visitor);break;
      case 'attribute':
        visitor.attribute(statement, morph, env, scope);break;
      case 'component':
        visitor.component(statement, morph, env, scope, template, visitor);break;
    }

    if (env.hooks.didRenderNode) {
      env.hooks.didRenderNode(morph, env, scope);
    }
  }
};

RenderResult.prototype.bindScope = function () {
  this.env.hooks.bindScope(this.env, this.scope);
};

RenderResult.prototype.updateScope = function () {
  this.env.hooks.updateScope(this.env, this.scope);
};

RenderResult.prototype.bindSelf = function (self) {
  this.env.hooks.bindSelf(this.env, this.scope, self);
};

RenderResult.prototype.updateSelf = function (self) {
  this.env.hooks.updateSelf(this.env, this.scope, self);
};

RenderResult.prototype.bindLocals = function (blockArguments) {
  var localNames = this.template.locals;

  for (var i = 0, l = localNames.length; i < l; i++) {
    this.env.hooks.bindLocal(this.env, this.scope, localNames[i], blockArguments[i]);
  }
};

RenderResult.prototype.updateLocals = function (blockArguments) {
  var localNames = this.template.locals;

  for (var i = 0, l = localNames.length; i < l; i++) {
    this.env.hooks.updateLocal(this.env, this.scope, localNames[i], blockArguments[i]);
  }
};

function initializeNode(node, owner) {
  node.ownerNode = owner;
}

function createChildMorph(dom, parentMorph, contextualElement) {
  var morph = _morph2.default.empty(dom, contextualElement || parentMorph.contextualElement);
  initializeNode(morph, parentMorph.ownerNode);
  return morph;
}

function getCachedFragment(template, env) {
  var dom = env.dom,
      fragment;
  if (env.useFragmentCache && dom.canClone) {
    if (template.cachedFragment === null) {
      fragment = template.buildFragment(dom);
      if (template.hasRendered) {
        template.cachedFragment = fragment;
      } else {
        template.hasRendered = true;
      }
    }
    if (template.cachedFragment) {
      fragment = dom.cloneNode(template.cachedFragment, true);
    }
  } else if (!fragment) {
    fragment = template.buildFragment(dom);
  }

  return fragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0bWxiYXJzLXJ1bnRpbWUvcmVuZGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7a0JBU3dCLE1BQU07Ozs7Ozs7OztzQ0FUQSw4QkFBOEI7OzJCQUM5QixnQkFBZ0I7Ozs7cUJBRTVCLFNBQVM7Ozs7eUNBQ2dCLGlDQUFpQzs7d0NBQ3hELGlDQUFpQzs7OztBQUVyRCxJQUFJLFlBQVksR0FBRyw0QkFBNEIsQ0FBQzs7QUFFakMsU0FBUyxNQUFNLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFO0FBQzVELE1BQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUM7QUFDbEIsTUFBSSxpQkFBaUIsQ0FBQzs7QUFFdEIsTUFBSSxPQUFPLEVBQUU7QUFDWCxRQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQUU7QUFDdEIsdUJBQWlCLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQztLQUMxRCxNQUFNLElBQUksT0FBTyxDQUFDLGlCQUFpQixFQUFFO0FBQ3BDLHVCQUFpQixHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQztLQUMvQztHQUNGOztBQUVELEtBQUcsQ0FBQyxlQUFlLENBQUMsaUJBQWlCLENBQUMsQ0FBQzs7QUFFdkMsTUFBSSxZQUFZLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztBQUN4RixjQUFZLENBQUMsTUFBTSxFQUFFLENBQUM7O0FBRXRCLFNBQU8sWUFBWSxDQUFDO0NBQ3JCOztBQUVNLFNBQVMsYUFBYSxDQUFDLFVBQVUsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLGlCQUFpQixFQUFFO0FBQ2pGLE1BQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxJQUFJLElBQUksQ0FBQztBQUNyQyxNQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUNqQixNQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsSUFBSSxJQUFJLENBQUM7QUFDN0MsTUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixJQUFJLElBQUksQ0FBQztDQUNwRDs7QUFFRCxTQUFTLFlBQVksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFO0FBQzNHLE1BQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDO0FBQ3JCLE1BQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDOztBQUV6QixNQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztBQUNuQixNQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztBQUN6QixNQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDOUMsTUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7QUFDZixNQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztBQUNuQixNQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7O0FBRXpDLE1BQUksT0FBTyxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7QUFBRSxRQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUFFO0FBQ2hFLE1BQUksT0FBTyxDQUFDLGNBQWMsS0FBSyxTQUFTLEVBQUU7QUFBRSxRQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztHQUFFOztBQUV0RixNQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQ2pDOztBQUVELFlBQVksQ0FBQyxLQUFLLEdBQUcsVUFBUyxHQUFHLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUU7QUFDOUUsTUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQztBQUNsQixNQUFJLFFBQVEsR0FBRyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDaEQsTUFBSSxLQUFLLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsaUJBQWlCLENBQUMsQ0FBQzs7QUFFeEUsTUFBSSxRQUFRLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixDQUFDOztBQUUxQyxNQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsVUFBVSxFQUFFO0FBQ2pDLFlBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDO0FBQzlCLGFBQVMsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDO0FBQy9CLG9CQUFnQixHQUFHLElBQUksQ0FBQztHQUN6QixNQUFNO0FBQ0wsWUFBUSxHQUFHLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxVQUFVLEVBQUUsUUFBUSxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0FBQzdGLGFBQVMsR0FBRyxRQUFRLENBQUM7QUFDckIsWUFBUSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFDL0Isb0JBQWdCLEdBQUcsS0FBSyxDQUFDO0dBQzFCOztBQUVELE1BQUksUUFBUSxDQUFDLFVBQVUsRUFBRTtBQUN2QiwwQ0FBYyxRQUFRLENBQUMsVUFBVSxFQUFFLFVBQVMsSUFBSSxFQUFFO0FBQ2hELDRDQUFXLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDN0IsQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsVUFBUSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7QUFDNUIsU0FBTyxJQUFJLFlBQVksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixDQUFDLENBQUM7Q0FDaEgsQ0FBQzs7QUFFSyxTQUFTLGFBQWEsQ0FBQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRTtBQUMzRCxNQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRXBCLE9BQUssSUFBSSxHQUFHLElBQUksVUFBVSxFQUFFO0FBQzFCLFFBQUksT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUSxFQUFFO0FBQUUsZUFBUztLQUFFOztBQUV0RCxjQUFVLENBQUMsSUFBSSxDQUFDLDBDQUFlLFdBQVcsRUFBRSxHQUFHLEVBQUUsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztHQUNwRTs7QUFFRCxNQUFJLE9BQU8sR0FBRyxRQUFRLElBQUksbUNBQVEsT0FBTyxDQUFDLENBQUM7O0FBRTNDLE1BQUksQ0FBQyxPQUFPLEVBQUU7QUFDWixjQUFVLENBQUMsSUFBSSxDQUFDLDBDQUFlLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0dBQ3JEOztBQUVELE1BQUksUUFBUSxHQUFHO0FBQ2IsU0FBSyxFQUFFLENBQUM7QUFDUixrQkFBYyxFQUFFLElBQUk7QUFDcEIsZUFBVyxFQUFFLEtBQUs7QUFDbEIsaUJBQWEsRUFBRSxTQUFTLGFBQWEsQ0FBQyxHQUFHLEVBQUU7QUFDekMsVUFBSSxHQUFHLEdBQUcsR0FBRyxDQUFDLHNCQUFzQixFQUFFLENBQUM7QUFDdkMsVUFBSSxPQUFPLEtBQUssS0FBSyxFQUFFO0FBQ3JCLFdBQUcsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7T0FDaEM7QUFDRCxVQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDOztBQUVyQyxXQUFLLElBQUksR0FBRyxJQUFJLFVBQVUsRUFBRTtBQUMxQixZQUFJLE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxLQUFLLFFBQVEsRUFBRTtBQUFFLG1CQUFTO1NBQUU7QUFDdEQsV0FBRyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO09BQzdDOztBQUVELFVBQUksQ0FBQyxPQUFPLEVBQUU7QUFDWixZQUFJLEdBQUcsR0FBRyxHQUFHLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2hDLFdBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO09BQzNCOztBQUVELFNBQUcsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDOztBQUUxQixhQUFPLEdBQUcsQ0FBQztLQUNaO0FBQ0Qsb0JBQWdCLEVBQUUsU0FBUyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFO0FBQ3pELFVBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN6QyxVQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7O0FBRWhCLFdBQUssSUFBSSxHQUFHLElBQUksVUFBVSxFQUFFO0FBQzFCLFlBQUksT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUSxFQUFFO0FBQUUsbUJBQVM7U0FBRTtBQUN0RCxjQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7T0FDaEQ7O0FBRUQsVUFBSSxDQUFDLE9BQU8sRUFBRTtBQUNaLGNBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7T0FDL0M7O0FBRUQsYUFBTyxNQUFNLENBQUM7S0FDZjtBQUNELGNBQVUsRUFBRSxVQUFVO0FBQ3RCLFVBQU0sRUFBRSxFQUFFO0FBQ1YsYUFBUyxFQUFFLEVBQUU7R0FDZCxDQUFDOztBQUVGLFNBQU8sUUFBUSxDQUFDO0NBQ2pCOztBQUVNLFNBQVMsZ0JBQWdCLENBQUMsVUFBVSxFQUFFO0FBQzNDLE1BQUksVUFBVSxHQUFHLEVBQUUsQ0FBQzs7QUFFcEIsT0FBSyxJQUFJLEdBQUcsSUFBSSxVQUFVLEVBQUU7QUFDMUIsUUFBSSxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxRQUFRLEVBQUU7QUFBRSxlQUFTO0tBQUU7QUFDdEQsY0FBVSxDQUFDLElBQUksQ0FBQywwQ0FBZSxXQUFXLEVBQUUsR0FBRyxFQUFFLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDcEU7O0FBRUQsTUFBSSxRQUFRLEdBQUc7QUFDYixTQUFLLEVBQUUsQ0FBQztBQUNSLGtCQUFjLEVBQUUsSUFBSTtBQUNwQixlQUFXLEVBQUUsS0FBSztBQUNsQixpQkFBYSxFQUFFLFNBQVMsYUFBYSxDQUFDLEdBQUcsRUFBRTtBQUN6QyxVQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQ3ZCLFVBQUksR0FBRyxDQUFDLFlBQVksS0FBSyw0QkFBNEIsRUFBRTtBQUNyRCxXQUFHLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO09BQ2hDO0FBQ0QsV0FBSyxJQUFJLEdBQUcsSUFBSSxVQUFVLEVBQUU7QUFDMUIsWUFBSSxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxRQUFRLEVBQUU7QUFBRSxtQkFBUztTQUFFO0FBQ3RELFdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztPQUM3Qzs7QUFFRCxhQUFPLEdBQUcsQ0FBQztLQUNaO0FBQ0Qsb0JBQWdCLEVBQUUsU0FBUyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUU7QUFDL0MsVUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztBQUMzQixVQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7O0FBRWhCLFdBQUssSUFBSSxHQUFHLElBQUksVUFBVSxFQUFFO0FBQzFCLFlBQUksT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLEtBQUssUUFBUSxFQUFFO0FBQUUsbUJBQVM7U0FBRTtBQUN0RCxjQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7T0FDaEQ7O0FBRUQsYUFBTyxNQUFNLENBQUM7S0FDZjtBQUNELGNBQVUsRUFBRSxVQUFVO0FBQ3RCLFVBQU0sRUFBRSxFQUFFO0FBQ1YsYUFBUyxFQUFFLEVBQUU7QUFDYixXQUFPLEVBQUUsSUFBSTtHQUNkLENBQUM7O0FBRUYsU0FBTyxRQUFRLENBQUM7Q0FDakI7O0FBRUQsWUFBWSxDQUFDLFNBQVMsQ0FBQyxlQUFlLEdBQUcsVUFBUyxTQUFTLEVBQUU7QUFDM0QsTUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7O0FBRXRDLE9BQUssSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDM0MsY0FBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7R0FDckM7Q0FDRixDQUFDOztBQUVGLFlBQVksQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLFlBQVc7QUFDekMsTUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQzVCLE1BQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztBQUMxQixNQUFJLENBQUMsYUFBYSxpQ0FBb0IsQ0FBQzs7QUFFdkMsTUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7QUFDakQsUUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0dBQ3JDO0NBQ0YsQ0FBQzs7QUFFRixZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxZQUFXO0FBQ3hDLHdDQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLFVBQVMsSUFBSSxFQUFFO0FBQUUsUUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7R0FBRSxDQUFDLENBQUM7Q0FDckUsQ0FBQzs7QUFFRixZQUFZLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFTLEdBQUcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRTtBQUM3RSxNQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGNBQWMsd0JBQW9CLENBQUM7Q0FDMUUsQ0FBQzs7QUFFRixZQUFZLENBQUMsU0FBUyxDQUFDLFFBQVEsR0FBRyxVQUFTLEdBQUcsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBRTtBQUMzRSxNQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGNBQWMsa0NBQXFCLENBQUM7Q0FDM0UsQ0FBQzs7QUFFRixZQUFZLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxVQUFTLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLGNBQWMsRUFBRSxPQUFPLEVBQUU7QUFDMUYsTUFBSSxHQUFHLEtBQUssU0FBUyxFQUFFO0FBQUUsUUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7R0FBRTtBQUMxQyxNQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7QUFBRSxRQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztHQUFFO0FBQ2hELE1BQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQzs7QUFFbkIsTUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO0FBQUUsUUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUFFO0FBQ2xELE1BQUksY0FBYyxLQUFLLFNBQVMsRUFBRTtBQUFFLFFBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7R0FBRTs7QUFFeEUsTUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztDQUM3QixDQUFDOztBQUVGLFlBQVksQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLFlBQVc7QUFDMUMsTUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztBQUN6Qix3Q0FBVyxRQUFRLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztDQUN0QyxDQUFDOztBQUVGLFlBQVksQ0FBQyxTQUFTLENBQUMsYUFBYSxHQUFHLFVBQVMsT0FBTyxFQUFFO0FBQ3ZELE1BQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7QUFDbkIsTUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztBQUN2QixNQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQzdCLE1BQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdkIsTUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztBQUNqQyxNQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7O0FBRVQsT0FBSyxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDdkMsUUFBSSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzlCLFFBQUksS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzs7QUFFckIsUUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRTtBQUM1QixTQUFHLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQzdDOztBQUVELFlBQVEsU0FBUyxDQUFDLENBQUMsQ0FBQztBQUNsQixXQUFLLE9BQU87QUFBRSxlQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDcEYsV0FBSyxRQUFRO0FBQUUsZUFBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDNUUsV0FBSyxTQUFTO0FBQUUsZUFBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDOUUsV0FBSyxTQUFTO0FBQUUsZUFBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLEFBQUMsTUFBTTtBQUFBLEFBQ3hGLFdBQUssV0FBVztBQUFFLGVBQU8sQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQUFBQyxNQUFNO0FBQUEsQUFDekUsV0FBSyxXQUFXO0FBQUUsZUFBTyxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLEFBQUMsTUFBTTtBQUFBLEtBQzdGOztBQUVELFFBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUU7QUFDM0IsU0FBRyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztLQUM1QztHQUNGO0NBQ0YsQ0FBQzs7QUFFRixZQUFZLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxZQUFXO0FBQzVDLE1BQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztDQUNoRCxDQUFDOztBQUVGLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxHQUFHLFlBQVc7QUFDOUMsTUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0NBQ2xELENBQUM7O0FBRUYsWUFBWSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEdBQUcsVUFBUyxJQUFJLEVBQUU7QUFDL0MsTUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztDQUNyRCxDQUFDOztBQUVGLFlBQVksQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLFVBQVMsSUFBSSxFQUFFO0FBQ2pELE1BQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7Q0FDdkQsQ0FBQzs7QUFFRixZQUFZLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFTLGNBQWMsRUFBRTtBQUMzRCxNQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQzs7QUFFdEMsT0FBSyxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtBQUMzQyxRQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztHQUNsRjtDQUNGLENBQUM7O0FBRUYsWUFBWSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUcsVUFBUyxjQUFjLEVBQUU7QUFDN0QsTUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7O0FBRXRDLE9BQUssSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDM0MsUUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDcEY7Q0FDRixDQUFDOztBQUVGLFNBQVMsY0FBYyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUU7QUFDbkMsTUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7Q0FDeEI7O0FBRU0sU0FBUyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLGlCQUFpQixFQUFFO0FBQ3BFLE1BQUksS0FBSyxHQUFHLGdCQUFNLEtBQUssQ0FBQyxHQUFHLEVBQUUsaUJBQWlCLElBQUksV0FBVyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDakYsZ0JBQWMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzdDLFNBQU8sS0FBSyxDQUFDO0NBQ2Q7O0FBRU0sU0FBUyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO0FBQy9DLE1BQUksR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHO01BQUUsUUFBUSxDQUFDO0FBQzVCLE1BQUksR0FBRyxDQUFDLGdCQUFnQixJQUFJLEdBQUcsQ0FBQyxRQUFRLEVBQUU7QUFDeEMsUUFBSSxRQUFRLENBQUMsY0FBYyxLQUFLLElBQUksRUFBRTtBQUNwQyxjQUFRLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2QyxVQUFJLFFBQVEsQ0FBQyxXQUFXLEVBQUU7QUFDeEIsZ0JBQVEsQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDO09BQ3BDLE1BQU07QUFDTCxnQkFBUSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7T0FDN0I7S0FDRjtBQUNELFFBQUksUUFBUSxDQUFDLGNBQWMsRUFBRTtBQUMzQixjQUFRLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3pEO0dBQ0YsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFO0FBQ3BCLFlBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBQ3hDOztBQUVELFNBQU8sUUFBUSxDQUFDO0NBQ2pCIiwiZmlsZSI6Imh0bWxiYXJzLXJ1bnRpbWUvcmVuZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgdmlzaXRDaGlsZHJlbiB9IGZyb20gXCIuLi9odG1sYmFycy11dGlsL21vcnBoLXV0aWxzXCI7XG5pbXBvcnQgRXhwcmVzc2lvblZpc2l0b3IgZnJvbSBcIi4vbm9kZS12aXNpdG9yXCI7XG5pbXBvcnQgeyBBbHdheXNEaXJ0eVZpc2l0b3IgfSBmcm9tIFwiLi9ub2RlLXZpc2l0b3JcIjtcbmltcG9ydCBNb3JwaCBmcm9tIFwiLi9tb3JwaFwiO1xuaW1wb3J0IHsgY2xlYXJNb3JwaCwgYnVpbGRTdGF0ZW1lbnQgfSBmcm9tIFwiLi4vaHRtbGJhcnMtdXRpbC90ZW1wbGF0ZS11dGlsc1wiO1xuaW1wb3J0IHZvaWRNYXAgZnJvbSAnLi4vaHRtbGJhcnMtdXRpbC92b2lkLXRhZy1uYW1lcyc7XG5cbnZhciBzdmdOYW1lc3BhY2UgPSBcImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnXCI7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHJlbmRlcih0ZW1wbGF0ZSwgZW52LCBzY29wZSwgb3B0aW9ucykge1xuICB2YXIgZG9tID0gZW52LmRvbTtcbiAgdmFyIGNvbnRleHR1YWxFbGVtZW50O1xuXG4gIGlmIChvcHRpb25zKSB7XG4gICAgaWYgKG9wdGlvbnMucmVuZGVyTm9kZSkge1xuICAgICAgY29udGV4dHVhbEVsZW1lbnQgPSBvcHRpb25zLnJlbmRlck5vZGUuY29udGV4dHVhbEVsZW1lbnQ7XG4gICAgfSBlbHNlIGlmIChvcHRpb25zLmNvbnRleHR1YWxFbGVtZW50KSB7XG4gICAgICBjb250ZXh0dWFsRWxlbWVudCA9IG9wdGlvbnMuY29udGV4dHVhbEVsZW1lbnQ7XG4gICAgfVxuICB9XG5cbiAgZG9tLmRldGVjdE5hbWVzcGFjZShjb250ZXh0dWFsRWxlbWVudCk7XG5cbiAgdmFyIHJlbmRlclJlc3VsdCA9IFJlbmRlclJlc3VsdC5idWlsZChlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgb3B0aW9ucywgY29udGV4dHVhbEVsZW1lbnQpO1xuICByZW5kZXJSZXN1bHQucmVuZGVyKCk7XG5cbiAgcmV0dXJuIHJlbmRlclJlc3VsdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIFJlbmRlck9wdGlvbnMocmVuZGVyTm9kZSwgc2VsZiwgYmxvY2tBcmd1bWVudHMsIGNvbnRleHR1YWxFbGVtZW50KSB7XG4gIHRoaXMucmVuZGVyTm9kZSA9IHJlbmRlck5vZGUgfHwgbnVsbDtcbiAgdGhpcy5zZWxmID0gc2VsZjtcbiAgdGhpcy5ibG9ja0FyZ3VtZW50cyA9IGJsb2NrQXJndW1lbnRzIHx8IG51bGw7XG4gIHRoaXMuY29udGV4dHVhbEVsZW1lbnQgPSBjb250ZXh0dWFsRWxlbWVudCB8fCBudWxsO1xufVxuXG5mdW5jdGlvbiBSZW5kZXJSZXN1bHQoZW52LCBzY29wZSwgb3B0aW9ucywgcm9vdE5vZGUsIG93bmVyTm9kZSwgbm9kZXMsIGZyYWdtZW50LCB0ZW1wbGF0ZSwgc2hvdWxkU2V0Q29udGVudCkge1xuICB0aGlzLnJvb3QgPSByb290Tm9kZTtcbiAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50O1xuXG4gIHRoaXMubm9kZXMgPSBub2RlcztcbiAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICB0aGlzLnN0YXRlbWVudHMgPSB0ZW1wbGF0ZS5zdGF0ZW1lbnRzLnNsaWNlKCk7XG4gIHRoaXMuZW52ID0gZW52O1xuICB0aGlzLnNjb3BlID0gc2NvcGU7XG4gIHRoaXMuc2hvdWxkU2V0Q29udGVudCA9IHNob3VsZFNldENvbnRlbnQ7XG5cbiAgaWYgKG9wdGlvbnMuc2VsZiAhPT0gdW5kZWZpbmVkKSB7IHRoaXMuYmluZFNlbGYob3B0aW9ucy5zZWxmKTsgfVxuICBpZiAob3B0aW9ucy5ibG9ja0FyZ3VtZW50cyAhPT0gdW5kZWZpbmVkKSB7IHRoaXMuYmluZExvY2FscyhvcHRpb25zLmJsb2NrQXJndW1lbnRzKTsgfVxuXG4gIHRoaXMuaW5pdGlhbGl6ZU5vZGVzKG93bmVyTm9kZSk7XG59XG5cblJlbmRlclJlc3VsdC5idWlsZCA9IGZ1bmN0aW9uKGVudiwgc2NvcGUsIHRlbXBsYXRlLCBvcHRpb25zLCBjb250ZXh0dWFsRWxlbWVudCkge1xuICB2YXIgZG9tID0gZW52LmRvbTtcbiAgdmFyIGZyYWdtZW50ID0gZ2V0Q2FjaGVkRnJhZ21lbnQodGVtcGxhdGUsIGVudik7XG4gIHZhciBub2RlcyA9IHRlbXBsYXRlLmJ1aWxkUmVuZGVyTm9kZXMoZG9tLCBmcmFnbWVudCwgY29udGV4dHVhbEVsZW1lbnQpO1xuXG4gIHZhciByb290Tm9kZSwgb3duZXJOb2RlLCBzaG91bGRTZXRDb250ZW50O1xuXG4gIGlmIChvcHRpb25zICYmIG9wdGlvbnMucmVuZGVyTm9kZSkge1xuICAgIHJvb3ROb2RlID0gb3B0aW9ucy5yZW5kZXJOb2RlO1xuICAgIG93bmVyTm9kZSA9IHJvb3ROb2RlLm93bmVyTm9kZTtcbiAgICBzaG91bGRTZXRDb250ZW50ID0gdHJ1ZTtcbiAgfSBlbHNlIHtcbiAgICByb290Tm9kZSA9IGRvbS5jcmVhdGVNb3JwaChudWxsLCBmcmFnbWVudC5maXJzdENoaWxkLCBmcmFnbWVudC5sYXN0Q2hpbGQsIGNvbnRleHR1YWxFbGVtZW50KTtcbiAgICBvd25lck5vZGUgPSByb290Tm9kZTtcbiAgICByb290Tm9kZS5vd25lck5vZGUgPSBvd25lck5vZGU7XG4gICAgc2hvdWxkU2V0Q29udGVudCA9IGZhbHNlO1xuICB9XG5cbiAgaWYgKHJvb3ROb2RlLmNoaWxkTm9kZXMpIHtcbiAgICB2aXNpdENoaWxkcmVuKHJvb3ROb2RlLmNoaWxkTm9kZXMsIGZ1bmN0aW9uKG5vZGUpIHtcbiAgICAgIGNsZWFyTW9ycGgobm9kZSwgZW52LCB0cnVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJvb3ROb2RlLmNoaWxkTm9kZXMgPSBub2RlcztcbiAgcmV0dXJuIG5ldyBSZW5kZXJSZXN1bHQoZW52LCBzY29wZSwgb3B0aW9ucywgcm9vdE5vZGUsIG93bmVyTm9kZSwgbm9kZXMsIGZyYWdtZW50LCB0ZW1wbGF0ZSwgc2hvdWxkU2V0Q29udGVudCk7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gbWFudWFsRWxlbWVudCh0YWdOYW1lLCBhdHRyaWJ1dGVzLCBfaXNFbXB0eSkge1xuICB2YXIgc3RhdGVtZW50cyA9IFtdO1xuXG4gIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVzW2tleV0gPT09ICdzdHJpbmcnKSB7IGNvbnRpbnVlOyB9XG5cbiAgICBzdGF0ZW1lbnRzLnB1c2goYnVpbGRTdGF0ZW1lbnQoXCJhdHRyaWJ1dGVcIiwga2V5LCBhdHRyaWJ1dGVzW2tleV0pKTtcbiAgfVxuXG4gIHZhciBpc0VtcHR5ID0gX2lzRW1wdHkgfHwgdm9pZE1hcFt0YWdOYW1lXTtcblxuICBpZiAoIWlzRW1wdHkpIHtcbiAgICBzdGF0ZW1lbnRzLnB1c2goYnVpbGRTdGF0ZW1lbnQoJ2NvbnRlbnQnLCAneWllbGQnKSk7XG4gIH1cblxuICB2YXIgdGVtcGxhdGUgPSB7XG4gICAgYXJpdHk6IDAsXG4gICAgY2FjaGVkRnJhZ21lbnQ6IG51bGwsXG4gICAgaGFzUmVuZGVyZWQ6IGZhbHNlLFxuICAgIGJ1aWxkRnJhZ21lbnQ6IGZ1bmN0aW9uIGJ1aWxkRnJhZ21lbnQoZG9tKSB7XG4gICAgICB2YXIgZWwwID0gZG9tLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTtcbiAgICAgIGlmICh0YWdOYW1lID09PSAnc3ZnJykge1xuICAgICAgICBkb20uc2V0TmFtZXNwYWNlKHN2Z05hbWVzcGFjZSk7XG4gICAgICB9XG4gICAgICB2YXIgZWwxID0gZG9tLmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7XG5cbiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlc1trZXldICE9PSAnc3RyaW5nJykgeyBjb250aW51ZTsgfVxuICAgICAgICBkb20uc2V0QXR0cmlidXRlKGVsMSwga2V5LCBhdHRyaWJ1dGVzW2tleV0pO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlzRW1wdHkpIHtcbiAgICAgICAgdmFyIGVsMiA9IGRvbS5jcmVhdGVDb21tZW50KFwiXCIpO1xuICAgICAgICBkb20uYXBwZW5kQ2hpbGQoZWwxLCBlbDIpO1xuICAgICAgfVxuXG4gICAgICBkb20uYXBwZW5kQ2hpbGQoZWwwLCBlbDEpO1xuXG4gICAgICByZXR1cm4gZWwwO1xuICAgIH0sXG4gICAgYnVpbGRSZW5kZXJOb2RlczogZnVuY3Rpb24gYnVpbGRSZW5kZXJOb2Rlcyhkb20sIGZyYWdtZW50KSB7XG4gICAgICB2YXIgZWxlbWVudCA9IGRvbS5jaGlsZEF0KGZyYWdtZW50LCBbMF0pO1xuICAgICAgdmFyIG1vcnBocyA9IFtdO1xuXG4gICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cmlidXRlcykge1xuICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZXNba2V5XSA9PT0gJ3N0cmluZycpIHsgY29udGludWU7IH1cbiAgICAgICAgbW9ycGhzLnB1c2goZG9tLmNyZWF0ZUF0dHJNb3JwaChlbGVtZW50LCBrZXkpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFpc0VtcHR5KSB7XG4gICAgICAgIG1vcnBocy5wdXNoKGRvbS5jcmVhdGVNb3JwaEF0KGVsZW1lbnQsIDAsIDApKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG1vcnBocztcbiAgICB9LFxuICAgIHN0YXRlbWVudHM6IHN0YXRlbWVudHMsXG4gICAgbG9jYWxzOiBbXSxcbiAgICB0ZW1wbGF0ZXM6IFtdXG4gIH07XG5cbiAgcmV0dXJuIHRlbXBsYXRlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXR0YWNoQXR0cmlidXRlcyhhdHRyaWJ1dGVzKSB7XG4gIHZhciBzdGF0ZW1lbnRzID0gW107XG5cbiAgZm9yICh2YXIga2V5IGluIGF0dHJpYnV0ZXMpIHtcbiAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZXNba2V5XSA9PT0gJ3N0cmluZycpIHsgY29udGludWU7IH1cbiAgICBzdGF0ZW1lbnRzLnB1c2goYnVpbGRTdGF0ZW1lbnQoXCJhdHRyaWJ1dGVcIiwga2V5LCBhdHRyaWJ1dGVzW2tleV0pKTtcbiAgfVxuXG4gIHZhciB0ZW1wbGF0ZSA9IHtcbiAgICBhcml0eTogMCxcbiAgICBjYWNoZWRGcmFnbWVudDogbnVsbCxcbiAgICBoYXNSZW5kZXJlZDogZmFsc2UsXG4gICAgYnVpbGRGcmFnbWVudDogZnVuY3Rpb24gYnVpbGRGcmFnbWVudChkb20pIHtcbiAgICAgIHZhciBlbDAgPSB0aGlzLmVsZW1lbnQ7XG4gICAgICBpZiAoZWwwLm5hbWVzcGFjZVVSSSA9PT0gXCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiKSB7XG4gICAgICAgIGRvbS5zZXROYW1lc3BhY2Uoc3ZnTmFtZXNwYWNlKTtcbiAgICAgIH1cbiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRyaWJ1dGVzKSB7XG4gICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlc1trZXldICE9PSAnc3RyaW5nJykgeyBjb250aW51ZTsgfVxuICAgICAgICBkb20uc2V0QXR0cmlidXRlKGVsMCwga2V5LCBhdHRyaWJ1dGVzW2tleV0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZWwwO1xuICAgIH0sXG4gICAgYnVpbGRSZW5kZXJOb2RlczogZnVuY3Rpb24gYnVpbGRSZW5kZXJOb2Rlcyhkb20pIHtcbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50O1xuICAgICAgdmFyIG1vcnBocyA9IFtdO1xuXG4gICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cmlidXRlcykge1xuICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZXNba2V5XSA9PT0gJ3N0cmluZycpIHsgY29udGludWU7IH1cbiAgICAgICAgbW9ycGhzLnB1c2goZG9tLmNyZWF0ZUF0dHJNb3JwaChlbGVtZW50LCBrZXkpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG1vcnBocztcbiAgICB9LFxuICAgIHN0YXRlbWVudHM6IHN0YXRlbWVudHMsXG4gICAgbG9jYWxzOiBbXSxcbiAgICB0ZW1wbGF0ZXM6IFtdLFxuICAgIGVsZW1lbnQ6IG51bGxcbiAgfTtcblxuICByZXR1cm4gdGVtcGxhdGU7XG59XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUuaW5pdGlhbGl6ZU5vZGVzID0gZnVuY3Rpb24ob3duZXJOb2RlKSB7XG4gIGxldCBjaGlsZE5vZGVzID0gdGhpcy5yb290LmNoaWxkTm9kZXM7XG5cbiAgZm9yIChsZXQgaT0wLCBsPWNoaWxkTm9kZXMubGVuZ3RoOyBpPGw7IGkrKykge1xuICAgIGNoaWxkTm9kZXNbaV0ub3duZXJOb2RlID0gb3duZXJOb2RlO1xuICB9XG59O1xuXG5SZW5kZXJSZXN1bHQucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkge1xuICB0aGlzLnJvb3QubGFzdFJlc3VsdCA9IHRoaXM7XG4gIHRoaXMucm9vdC5yZW5kZXJlZCA9IHRydWU7XG4gIHRoaXMucG9wdWxhdGVOb2RlcyhBbHdheXNEaXJ0eVZpc2l0b3IpO1xuXG4gIGlmICh0aGlzLnNob3VsZFNldENvbnRlbnQgJiYgdGhpcy5yb290LnNldENvbnRlbnQpIHtcbiAgICB0aGlzLnJvb3Quc2V0Q29udGVudCh0aGlzLmZyYWdtZW50KTtcbiAgfVxufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5kaXJ0eSA9IGZ1bmN0aW9uKCkge1xuICB2aXNpdENoaWxkcmVuKFt0aGlzLnJvb3RdLCBmdW5jdGlvbihub2RlKSB7IG5vZGUuaXNEaXJ0eSA9IHRydWU7IH0pO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5yZXZhbGlkYXRlID0gZnVuY3Rpb24oZW52LCBzZWxmLCBibG9ja0FyZ3VtZW50cywgc2NvcGUpIHtcbiAgdGhpcy5yZXZhbGlkYXRlV2l0aChlbnYsIHNjb3BlLCBzZWxmLCBibG9ja0FyZ3VtZW50cywgRXhwcmVzc2lvblZpc2l0b3IpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5yZXJlbmRlciA9IGZ1bmN0aW9uKGVudiwgc2VsZiwgYmxvY2tBcmd1bWVudHMsIHNjb3BlKSB7XG4gIHRoaXMucmV2YWxpZGF0ZVdpdGgoZW52LCBzY29wZSwgc2VsZiwgYmxvY2tBcmd1bWVudHMsIEFsd2F5c0RpcnR5VmlzaXRvcik7XG59O1xuXG5SZW5kZXJSZXN1bHQucHJvdG90eXBlLnJldmFsaWRhdGVXaXRoID0gZnVuY3Rpb24oZW52LCBzY29wZSwgc2VsZiwgYmxvY2tBcmd1bWVudHMsIHZpc2l0b3IpIHtcbiAgaWYgKGVudiAhPT0gdW5kZWZpbmVkKSB7IHRoaXMuZW52ID0gZW52OyB9XG4gIGlmIChzY29wZSAhPT0gdW5kZWZpbmVkKSB7IHRoaXMuc2NvcGUgPSBzY29wZTsgfVxuICB0aGlzLnVwZGF0ZVNjb3BlKCk7XG5cbiAgaWYgKHNlbGYgIT09IHVuZGVmaW5lZCkgeyB0aGlzLnVwZGF0ZVNlbGYoc2VsZik7IH1cbiAgaWYgKGJsb2NrQXJndW1lbnRzICE9PSB1bmRlZmluZWQpIHsgdGhpcy51cGRhdGVMb2NhbHMoYmxvY2tBcmd1bWVudHMpOyB9XG5cbiAgdGhpcy5wb3B1bGF0ZU5vZGVzKHZpc2l0b3IpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gIHZhciByb290Tm9kZSA9IHRoaXMucm9vdDtcbiAgY2xlYXJNb3JwaChyb290Tm9kZSwgdGhpcy5lbnYsIHRydWUpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5wb3B1bGF0ZU5vZGVzID0gZnVuY3Rpb24odmlzaXRvcikge1xuICB2YXIgZW52ID0gdGhpcy5lbnY7XG4gIHZhciBzY29wZSA9IHRoaXMuc2NvcGU7XG4gIHZhciB0ZW1wbGF0ZSA9IHRoaXMudGVtcGxhdGU7XG4gIHZhciBub2RlcyA9IHRoaXMubm9kZXM7XG4gIHZhciBzdGF0ZW1lbnRzID0gdGhpcy5zdGF0ZW1lbnRzO1xuICB2YXIgaSwgbDtcblxuICBmb3IgKGk9MCwgbD1zdGF0ZW1lbnRzLmxlbmd0aDsgaTxsOyBpKyspIHtcbiAgICB2YXIgc3RhdGVtZW50ID0gc3RhdGVtZW50c1tpXTtcbiAgICB2YXIgbW9ycGggPSBub2Rlc1tpXTtcblxuICAgIGlmIChlbnYuaG9va3Mud2lsbFJlbmRlck5vZGUpIHtcbiAgICAgIGVudi5ob29rcy53aWxsUmVuZGVyTm9kZShtb3JwaCwgZW52LCBzY29wZSk7XG4gICAgfVxuXG4gICAgc3dpdGNoIChzdGF0ZW1lbnRbMF0pIHtcbiAgICAgIGNhc2UgJ2Jsb2NrJzogdmlzaXRvci5ibG9jayhzdGF0ZW1lbnQsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcik7IGJyZWFrO1xuICAgICAgY2FzZSAnaW5saW5lJzogdmlzaXRvci5pbmxpbmUoc3RhdGVtZW50LCBtb3JwaCwgZW52LCBzY29wZSwgdmlzaXRvcik7IGJyZWFrO1xuICAgICAgY2FzZSAnY29udGVudCc6IHZpc2l0b3IuY29udGVudChzdGF0ZW1lbnQsIG1vcnBoLCBlbnYsIHNjb3BlLCB2aXNpdG9yKTsgYnJlYWs7XG4gICAgICBjYXNlICdlbGVtZW50JzogdmlzaXRvci5lbGVtZW50KHN0YXRlbWVudCwgbW9ycGgsIGVudiwgc2NvcGUsIHRlbXBsYXRlLCB2aXNpdG9yKTsgYnJlYWs7XG4gICAgICBjYXNlICdhdHRyaWJ1dGUnOiB2aXNpdG9yLmF0dHJpYnV0ZShzdGF0ZW1lbnQsIG1vcnBoLCBlbnYsIHNjb3BlKTsgYnJlYWs7XG4gICAgICBjYXNlICdjb21wb25lbnQnOiB2aXNpdG9yLmNvbXBvbmVudChzdGF0ZW1lbnQsIG1vcnBoLCBlbnYsIHNjb3BlLCB0ZW1wbGF0ZSwgdmlzaXRvcik7IGJyZWFrO1xuICAgIH1cblxuICAgIGlmIChlbnYuaG9va3MuZGlkUmVuZGVyTm9kZSkge1xuICAgICAgZW52Lmhvb2tzLmRpZFJlbmRlck5vZGUobW9ycGgsIGVudiwgc2NvcGUpO1xuICAgIH1cbiAgfVxufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5iaW5kU2NvcGUgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5lbnYuaG9va3MuYmluZFNjb3BlKHRoaXMuZW52LCB0aGlzLnNjb3BlKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUudXBkYXRlU2NvcGUgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5lbnYuaG9va3MudXBkYXRlU2NvcGUodGhpcy5lbnYsIHRoaXMuc2NvcGUpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS5iaW5kU2VsZiA9IGZ1bmN0aW9uKHNlbGYpIHtcbiAgdGhpcy5lbnYuaG9va3MuYmluZFNlbGYodGhpcy5lbnYsIHRoaXMuc2NvcGUsIHNlbGYpO1xufTtcblxuUmVuZGVyUmVzdWx0LnByb3RvdHlwZS51cGRhdGVTZWxmID0gZnVuY3Rpb24oc2VsZikge1xuICB0aGlzLmVudi5ob29rcy51cGRhdGVTZWxmKHRoaXMuZW52LCB0aGlzLnNjb3BlLCBzZWxmKTtcbn07XG5cblJlbmRlclJlc3VsdC5wcm90b3R5cGUuYmluZExvY2FscyA9IGZ1bmN0aW9uKGJsb2NrQXJndW1lbnRzKSB7XG4gIHZhciBsb2NhbE5hbWVzID0gdGhpcy50ZW1wbGF0ZS5sb2NhbHM7XG5cbiAgZm9yICh2YXIgaT0wLCBsPWxvY2FsTmFtZXMubGVuZ3RoOyBpPGw7IGkrKykge1xuICAgIHRoaXMuZW52Lmhvb2tzLmJpbmRMb2NhbCh0aGlzLmVudiwgdGhpcy5zY29wZSwgbG9jYWxOYW1lc1tpXSwgYmxvY2tBcmd1bWVudHNbaV0pO1xuICB9XG59O1xuXG5SZW5kZXJSZXN1bHQucHJvdG90eXBlLnVwZGF0ZUxvY2FscyA9IGZ1bmN0aW9uKGJsb2NrQXJndW1lbnRzKSB7XG4gIHZhciBsb2NhbE5hbWVzID0gdGhpcy50ZW1wbGF0ZS5sb2NhbHM7XG5cbiAgZm9yICh2YXIgaT0wLCBsPWxvY2FsTmFtZXMubGVuZ3RoOyBpPGw7IGkrKykge1xuICAgIHRoaXMuZW52Lmhvb2tzLnVwZGF0ZUxvY2FsKHRoaXMuZW52LCB0aGlzLnNjb3BlLCBsb2NhbE5hbWVzW2ldLCBibG9ja0FyZ3VtZW50c1tpXSk7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIGluaXRpYWxpemVOb2RlKG5vZGUsIG93bmVyKSB7XG4gIG5vZGUub3duZXJOb2RlID0gb3duZXI7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDaGlsZE1vcnBoKGRvbSwgcGFyZW50TW9ycGgsIGNvbnRleHR1YWxFbGVtZW50KSB7XG4gIHZhciBtb3JwaCA9IE1vcnBoLmVtcHR5KGRvbSwgY29udGV4dHVhbEVsZW1lbnQgfHwgcGFyZW50TW9ycGguY29udGV4dHVhbEVsZW1lbnQpO1xuICBpbml0aWFsaXplTm9kZShtb3JwaCwgcGFyZW50TW9ycGgub3duZXJOb2RlKTtcbiAgcmV0dXJuIG1vcnBoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2FjaGVkRnJhZ21lbnQodGVtcGxhdGUsIGVudikge1xuICB2YXIgZG9tID0gZW52LmRvbSwgZnJhZ21lbnQ7XG4gIGlmIChlbnYudXNlRnJhZ21lbnRDYWNoZSAmJiBkb20uY2FuQ2xvbmUpIHtcbiAgICBpZiAodGVtcGxhdGUuY2FjaGVkRnJhZ21lbnQgPT09IG51bGwpIHtcbiAgICAgIGZyYWdtZW50ID0gdGVtcGxhdGUuYnVpbGRGcmFnbWVudChkb20pO1xuICAgICAgaWYgKHRlbXBsYXRlLmhhc1JlbmRlcmVkKSB7XG4gICAgICAgIHRlbXBsYXRlLmNhY2hlZEZyYWdtZW50ID0gZnJhZ21lbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0ZW1wbGF0ZS5oYXNSZW5kZXJlZCA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh0ZW1wbGF0ZS5jYWNoZWRGcmFnbWVudCkge1xuICAgICAgZnJhZ21lbnQgPSBkb20uY2xvbmVOb2RlKHRlbXBsYXRlLmNhY2hlZEZyYWdtZW50LCB0cnVlKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoIWZyYWdtZW50KSB7XG4gICAgZnJhZ21lbnQgPSB0ZW1wbGF0ZS5idWlsZEZyYWdtZW50KGRvbSk7XG4gIH1cblxuICByZXR1cm4gZnJhZ21lbnQ7XG59XG4iXX0=